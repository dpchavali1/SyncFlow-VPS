/**
 * Admin Cleanup Page - Comprehensive System Management Dashboard
 *
 * This page provides administrators with tools to manage and optimize the SyncFlow
 * system, including database cleanup, user management, and cost optimization.
 *
 * ACCESS CONTROL:
 * - Requires admin authentication (admin claim in Firebase token)
 * - Session validated via localStorage and Firebase Auth state
 * - Auto-redirects to login if session is invalid
 *
 * KEY FEATURES:
 * 1. OVERVIEW TAB
 *    - System health metrics (users, messages, storage)
 *    - Firebase cost estimates
 *
 * 2. USERS TAB
 *    - Detailed user list with search and filtering
 *    - Individual user deletion
 *    - Bulk delete inactive users
 *
 * 3. DATA & CLEANUP TAB
 *    - Auto cleanup (12 categories)
 *    - Smart global cleanup (plan-based retention)
 *    - Orphan detection and cleanup
 *    - Duplicate user detection
 *    - Message retention enforcement
 *    - Device registry cleanup
 *
 * 4. R2 STORAGE TAB
 *    - Cloudflare R2 analytics
 *    - File type breakdown (files, MMS, photos)
 *    - Cleanup by age and type
 *    - Individual file deletion
 *
 * 5. COSTS TAB
 *    - Cost optimization recommendations
 *    - One-click implementation of recommendations
 *
 * 6. TESTING TAB
 *    - Assign user plans for testing
 *    - Plan expiration management
 *
 * ARCHITECTURE:
 * - Server-side operations via Firebase Cloud Functions
 * - Real-time activity logging
 * - Progress tracking for long-running operations
 *
 * @module app/admin/cleanup/page
 */

'use client'

import { useState, useEffect, useRef } from 'react'
import { useRouter } from 'next/navigation'
import {
  Trash2,
  RefreshCw,
  Database,
  AlertTriangle,
  AlertCircle,
  Loader2,
  Shield,
  ShieldX,
  HardDrive,
  Mail,
  MessageSquare,
  Users,
  Zap,
  LogOut,
  BarChart3,
  TrendingUp,
  TrendingDown,
  DollarSign,
  Activity,
  Search,
  UserX,
  Cloud,
  FileImage,
  File,
  Calendar,
  LineChart,
  Eye,
  ScrollText,
  Key,
  Wifi,
  WifiOff,
  Power,
  Pencil,
  X,
  Check,
} from 'lucide-react'
import { costMonitor } from '@/lib/monitoring'
import { cacheManager } from '@/lib/cache'
import { ConfirmDialog } from '@/components/ConfirmDialog'
import { vpsService } from '@/lib/vps'

// Type aliases for compatibility
type OrphanCounts = { orphanedMessages: number; orphanedContacts: number; orphanedDevices: number; orphanedCalls: number; usersWithoutDevices: number; usersWithoutMessages: number }
type CleanupStats = { totalDeleted: number; breakdown: Record<string, number> }
type R2Analytics = { totalFiles: number; totalSize: number; estimatedCost: number; fileCounts: { files: number; mms: number; photos: number }; sizeCounts: { files: number; mms: number; photos: number }; largestFiles: any[]; oldestFiles: any[]; userStorage: any[]; totalUsersWithStorage: number; r2Available: boolean; [key: string]: any }
type R2File = { source: string; userId: string; fileName: string; fileSize: number; r2Key: string; createdAt: string }
type CrashReport = { id: string; userId: string | null; isFatal: boolean; context: string; timestamp: number; timestampFormatted: string; exceptionType: string; exceptionMessage: string; stackTrace: string; cause?: { type: string; message: string } | null; appVersion: string; appVersionCode: number; buildType: string; deviceManufacturer: string; deviceModel: string; deviceBrand: string; androidVersion: string; androidSdkInt: number; deviceId: string; resolved: boolean; resolvedBy?: string; resolvedAt?: string; notes?: string }
type CrashStats = { totalCrashes: number; fatalCrashes: number; nonFatalCrashes: number; unresolvedCrashes: number; uniqueUsers: number; anonymousCrashes: number; topExceptions: Array<{ type: string; count: number }>; crashesByDevice: any[]; crashesByVersion: any[] }

/**
 * Represents an admin authentication session stored in localStorage
 */
interface AdminSession {
  authenticated: boolean
  timestamp: number
  expiresAt: number
}

/**
 * High-level system metrics displayed on the Overview tab
 */
interface SystemOverview {
  totalUsers: number
  databaseSize: number
  systemHealth: {
    status: 'healthy' | 'warning' | 'critical'
    issues: string[]
  }
}

/**
 * Detailed user information for the Users tab table
 */
interface DetailedUser {
  userId: string
  phone: string | null
  email: string | null
  messagesCount: number
  devicesCount: number
  storageUsedMB: number
  lastActivity: number | null
  plan: string
  planExpiresAt: number | null
  planAssignedAt: number | null
  planAssignedBy: string
  wasPremium: boolean
  isActive: boolean
}

/**
 * Cost optimization recommendation generated by the analysis system
 */
interface CostRecommendation {
  type: 'storage' | 'database' | 'cleanup' | 'scaling'
  priority: 'high' | 'medium' | 'low'
  title: string
  description: string
  potentialSavings: number
  action: string
}

/**
 * Validates the admin session stored in localStorage
 * Checks for existence, authentication flag, and expiration
 *
 * @returns true if session is valid and not expired
 */
const isValidAdminSession = (): boolean => {
  try {
    const sessionStr = localStorage.getItem('syncflow_admin_session')
    if (!sessionStr) return false

    const session: AdminSession = JSON.parse(sessionStr)
    if (!session.authenticated) return false

    // Check if session has expired
    if (Date.now() > session.expiresAt) {
      localStorage.removeItem('syncflow_admin_session')
      return false
    }
    return true
  } catch {
    return false
  }
}

/**
 * AdminCleanupPage - Main admin dashboard component
 *
 * Provides a comprehensive interface for system administration including:
 * - System health monitoring
 * - User management
 * - Data cleanup operations
 * - R2 storage management
 * - Cost optimization
 * - Testing utilities
 */
export default function AdminCleanupPage() {
  const router = useRouter()

  // Check VPS mode - Firebase cleanup not available in VPS mode
  useEffect(() => {
    const isVPSMode = localStorage.getItem('useVPSMode') === 'true' ||
                      !!process.env.NEXT_PUBLIC_VPS_URL ||
                      !!localStorage.getItem('vps_access_token') ||
                      true // Default to VPS mode

    if (isVPSMode) {
      console.log('[AdminCleanup] VPS mode active - Firebase cleanup not available')
      // Show message instead of redirecting, in case admin wants to access Firebase cleanup specifically
    }
  }, [])

  // ============================================
  // AUTHENTICATION STATE
  // ============================================
  const [userId, setUserId] = useState<string | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [isAuthorized, setIsAuthorized] = useState(false)

  // ============================================
  // CLEANUP OPERATION STATE
  // ============================================
  const [isRunningAuto, setIsRunningAuto] = useState(false)
  const [cleanupLog, setCleanupLog] = useState<string[]>([])

  // ============================================
  // NAVIGATION AND DATA STATE
  // ============================================
  const [activeTab, setActiveTab] = useState<'overview' | 'users' | 'data' | 'costs' | 'storage' | 'crashes' | 'testing' | 'monitoring' | 'database' | 'lookup' | 'live' | 'logs'>('overview')
  const [systemOverview, setSystemOverview] = useState<SystemOverview | null>(null)
  const [detailedCleanupOverview, setDetailedCleanupOverview] = useState<any | null>(null)
  const [detailedUsers, setDetailedUsers] = useState<DetailedUser[]>([])
  const [costRecommendations, setCostRecommendations] = useState<CostRecommendation[]>([])
  const [userSearchTerm, setUserSearchTerm] = useState('')
  const [userFilter, setUserFilter] = useState<'all' | 'active' | 'inactive'>('all')
  const [currentPage, setCurrentPage] = useState(0)
  const [pageSize] = useState(20)
  const [totalPages, setTotalPages] = useState(0)
  const [totalUserCount, setTotalUserCount] = useState(0)
  const [hasNextPage, setHasNextPage] = useState(false)
  const [hasPrevPage, setHasPrevPage] = useState(false)
  const [isLoadingUsers, setIsLoadingUsers] = useState(false)
  const [usersError, setUsersError] = useState<string | null>(null)

  /**
   * Handler for user filter dropdown changes
   */
  const onFilterChange = (filter: 'all' | 'active' | 'inactive') => {
    setUserFilter(filter)
    setCurrentPage(0) // Reset to first page when filter changes
  }

  // ============================================
  // LOADING AND OPERATION STATE
  // ============================================
  const [isLoadingOverview, setIsLoadingOverview] = useState(false)
  const [deletingUser, setDeletingUser] = useState<string | null>(null)
  const [isRunningBulkDelete, setIsRunningBulkDelete] = useState(false)
  const [isRunningDeviceCleanup, setIsRunningDeviceCleanup] = useState(false)

  // ============================================
  // COST OPTIMIZATION STATE
  // ============================================
  const [isDetectingOrphans, setIsDetectingOrphans] = useState(false)
  const [isRunningSmartCleanup, setIsRunningSmartCleanup] = useState(false)
  const [isDetectingDuplicates, setIsDetectingDuplicates] = useState(false)
  const [isDeletingDuplicates, setIsDeletingDuplicates] = useState(false)
  const [orphanCounts, setOrphanCounts] = useState<OrphanCounts | null>(null)
  const [duplicatesList, setDuplicatesList] = useState<any[]>([])
  const [totalDuplicateAccounts, setTotalDuplicateAccounts] = useState(0)
  const [isDeletingNoDeviceUsers, setIsDeletingNoDeviceUsers] = useState(false)
  const [isDeletingOldMessages, setIsDeletingOldMessages] = useState(false)
  const [isDeletingOldMms, setIsDeletingOldMms] = useState(false)
  const [isEnforcingSms, setIsEnforcingSms] = useState(false)

  // Cost Monitoring State (VPS)
  const [costEstimate, setCostEstimate] = useState<any>(null)
  const [bandwidth, setBandwidth] = useState<any>(null)
  const [analyticsRetention, setAnalyticsRetention] = useState<any>(null)
  const [analyticsDashboard, setAnalyticsDashboard] = useState<any>(null)
  const [analyticsFeatures, setAnalyticsFeatures] = useState<any[]>([])
  const [isLoadingCosts, setIsLoadingCosts] = useState(false)

  // ============================================
  // TESTING TAB STATE
  // ============================================
  const [testUserId, setTestUserId] = useState('')
  const [testPlan, setTestPlan] = useState<'free' | 'monthly' | 'yearly' | 'lifetime'>('free')
  const [testDaysValid, setTestDaysValid] = useState('7')
  const [isSettingPlan, setIsSettingPlan] = useState(false)

  // ============================================
  // R2 STORAGE TAB STATE
  // ============================================
  const [r2Analytics, setR2Analytics] = useState<R2Analytics | null>(null)
  const [r2FileList, setR2FileList] = useState<R2File[]>([])
  const [isLoadingR2, setIsLoadingR2] = useState(false)
  const [isCleaningR2, setIsCleaningR2] = useState(false)
  const [r2CleanupDays, setR2CleanupDays] = useState('90')
  const [r2FileTypeFilter, setR2FileTypeFilter] = useState<'all' | 'files' | 'mms' | 'photos'>('all')
  const [deletingR2File, setDeletingR2File] = useState<string | null>(null)
  const [recalculatingUser, setRecalculatingUser] = useState<string | null>(null)
  const [isCleaningOrphaned, setIsCleaningOrphaned] = useState(false)
  const [orphanedFileCount, setOrphanedFileCount] = useState<number>(0)
  const [orphanedFileSize, setOrphanedFileSize] = useState<number>(0)

  // ============================================
  // CRASH REPORTS TAB STATE
  // ============================================
  const [crashReports, setCrashReports] = useState<CrashReport[]>([])
  const [crashStats, setCrashStats] = useState<CrashStats | null>(null)
  const [isLoadingCrashes, setIsLoadingCrashes] = useState(false)
  const [crashFilter, setCrashFilter] = useState<'all' | 'unresolved' | 'fatal' | 'non-fatal'>('unresolved')
  const [crashSearchTerm, setCrashSearchTerm] = useState('')
  const [selectedCrash, setSelectedCrash] = useState<CrashReport | null>(null)
  const [resolvingCrash, setResolvingCrash] = useState<string | null>(null)
  const [deletingCrash, setDeletingCrash] = useState<string | null>(null)

  // ============================================
  // DATABASE BROWSER STATE
  // ============================================
  const [dbTables, setDbTables] = useState<Array<{ name: string; estimatedRows: number; totalSize: string; totalSizeBytes: number }>>([])
  const [dbHealth, setDbHealth] = useState<{ dbSize: string; activeConnections: number; maxConnections: number; uptime: string } | null>(null)
  const [dbTableFilter, setDbTableFilter] = useState('')
  const [dbTableSortField, setDbTableSortField] = useState<'name' | 'estimatedRows' | 'totalSizeBytes'>('totalSizeBytes')
  const [dbTableSortOrder, setDbTableSortOrder] = useState<'asc' | 'desc'>('desc')
  const [isLoadingDb, setIsLoadingDb] = useState(false)
  // Table data view
  const [dbSelectedTable, setDbSelectedTable] = useState<string | null>(null)
  const [dbSchema, setDbSchema] = useState<Array<{ name: string; type: string; nullable: boolean; default: string | null; maxLength: number | null; isPrimaryKey: boolean }>>([])
  const [dbRows, setDbRows] = useState<any[]>([])
  const [dbColumns, setDbColumns] = useState<string[]>([])
  const [dbTotal, setDbTotal] = useState(0)
  const [dbPage, setDbPage] = useState(0)
  const [dbPageSize] = useState(50)
  const [dbSort, setDbSort] = useState<string | null>(null)
  const [dbSortDir, setDbSortDir] = useState<'ASC' | 'DESC'>('DESC')
  const [dbSearch, setDbSearch] = useState('')
  const [isLoadingDbData, setIsLoadingDbData] = useState(false)
  const [dbError, setDbError] = useState('')

  // Database: SQL query
  const [dbSqlQuery, setDbSqlQuery] = useState('')
  const [dbQueryResult, setDbQueryResult] = useState<any>(null)
  const [dbQueryError, setDbQueryError] = useState('')
  const [dbQueryLoading, setDbQueryLoading] = useState(false)
  const [dbActiveSubTab, setDbActiveSubTab] = useState<'browse' | 'query'>('browse')

  // Database: Row edit/delete
  const [dbEditingRow, setDbEditingRow] = useState<any>(null)
  const [dbEditValues, setDbEditValues] = useState<Record<string, any>>({})
  const [dbEditLoading, setDbEditLoading] = useState(false)
  const [dbEditError, setDbEditError] = useState('')
  const [dbDeletingRow, setDbDeletingRow] = useState<any>(null)
  const [dbDeleteLoading, setDbDeleteLoading] = useState(false)

  // ============================================
  // LOOKUP TAB STATE
  // ============================================
  const [lookupQuery, setLookupQuery] = useState('')
  const [lookupResults, setLookupResults] = useState<any[]>([])
  const [isLoadingLookup, setIsLoadingLookup] = useState(false)
  const [lookupError, setLookupError] = useState('')

  // ============================================
  // LIVE TAB STATE
  // ============================================
  const [liveSessions, setLiveSessions] = useState<any>(null)
  const [e2eeHealth, setE2eeHealth] = useState<any>(null)
  const [isLoadingLive, setIsLoadingLive] = useState(false)

  // ============================================
  // LOGS TAB STATE
  // ============================================
  const [serverLogs, setServerLogs] = useState<any[]>([])
  const [logsTotal, setLogsTotal] = useState(0)
  const [logLevelFilter, setLogLevelFilter] = useState('all')
  const [logSearchTerm, setLogSearchTerm] = useState('')
  const [isLoadingLogs, setIsLoadingLogs] = useState(false)

  // ============================================
  // OVERVIEW ENHANCEMENTS STATE
  // ============================================
  const [maintenanceEnabled, setMaintenanceEnabled] = useState(false)
  const [maintenanceMessage, setMaintenanceMessage] = useState('')
  const [isTogglingMaintenance, setIsTogglingMaintenance] = useState(false)
  const [systemAlerts, setSystemAlerts] = useState<any[]>([])
  const [isLoadingAlerts, setIsLoadingAlerts] = useState(false)
  const [onlineCount, setOnlineCount] = useState<number | null>(null)

  // ============================================
  // CONFIRM DIALOG STATE
  // ============================================
  const [confirmDialog, setConfirmDialog] = useState<{
    open: boolean
    title: string
    message: string
    confirmText?: string
    confirmButtonText?: string
    requireTyping?: boolean
    onConfirm: () => void
  } | null>(null)

  /** Ref for auto-scrolling the activity log container */
  const logContainerRef = useRef<HTMLDivElement>(null)

  /**
   * Adds a timestamped entry to the cleanup activity log
   * @param message - Log message to add
   */
  const addLog = (message: string) => {
    setCleanupLog(prev => [...prev, `${new Date().toLocaleTimeString()}: ${message}`])
  }

  // ============================================
  // NEW FEATURE LOADING FUNCTIONS
  // ============================================

  const loadLookup = async () => {
    if (!lookupQuery.trim()) return
    setIsLoadingLookup(true)
    setLookupError('')
    try {
      const data = await vpsService.adminUserLookup(lookupQuery.trim())
      setLookupResults(data.results || [])
      if ((data.results || []).length === 0) setLookupError('No users found')
    } catch (e: any) {
      setLookupError(e.message || 'Lookup failed')
      setLookupResults([])
    } finally {
      setIsLoadingLookup(false)
    }
  }

  const loadLiveSessions = async () => {
    setIsLoadingLive(true)
    try {
      const [sessions, e2ee] = await Promise.all([
        vpsService.getAdminSessions(),
        vpsService.getAdminE2EEHealth(),
      ])
      setLiveSessions(sessions)
      setE2eeHealth(e2ee)
      setOnlineCount(sessions.onlineCount)
    } catch (e: any) {
      console.error('Failed to load live sessions:', e)
    } finally {
      setIsLoadingLive(false)
    }
  }

  const loadServerLogs = async () => {
    setIsLoadingLogs(true)
    try {
      const data = await vpsService.getAdminLogs({
        limit: 200,
        level: logLevelFilter !== 'all' ? logLevelFilter : undefined,
        search: logSearchTerm || undefined,
      })
      setServerLogs(data.logs || [])
      setLogsTotal(data.total || 0)
    } catch (e: any) {
      console.error('Failed to load logs:', e)
    } finally {
      setIsLoadingLogs(false)
    }
  }

  const loadAlerts = async () => {
    setIsLoadingAlerts(true)
    try {
      const data = await vpsService.getAdminAlerts()
      setSystemAlerts(data.alerts || [])
    } catch (e: any) {
      console.error('Failed to load alerts:', e)
    } finally {
      setIsLoadingAlerts(false)
    }
  }

  const loadMaintenanceStatus = async () => {
    try {
      const data = await vpsService.getAdminMaintenance()
      setMaintenanceEnabled(data.enabled)
      setMaintenanceMessage(data.message || '')
    } catch {}
  }

  const toggleMaintenance = async () => {
    setIsTogglingMaintenance(true)
    try {
      const newState = !maintenanceEnabled
      await vpsService.setAdminMaintenance(newState, maintenanceMessage)
      setMaintenanceEnabled(newState)
      addLog(`Maintenance mode ${newState ? 'ENABLED' : 'DISABLED'}`)
    } catch (e: any) {
      addLog(`Failed to toggle maintenance: ${e.message}`)
    } finally {
      setIsTogglingMaintenance(false)
    }
  }

  // ============================================
  // DATA LOADING FUNCTIONS
  // ============================================

  /**
   * Loads system overview metrics from Firebase
   * Updates the Overview tab with current system health data
   */
  const loadSystemOverview = async () => {
    setIsLoadingOverview(true)
    try {
      let overview: any
      try {
        // Try the full overview endpoint first (new server)
        overview = await vpsService.getAdminOverview()
      } catch {
        // Fall back to basic stats endpoint (old server)
        overview = await vpsService.getAdminStats()
      }

      // Transform VPS response to match UI expectations
      const issues: string[] = []
      // Handle both response formats: { users: { total } } (new) or { totalUsers } (old/stats)
      const totalUsers = overview.users?.total ?? overview.totalUsers ?? 0
      const totalMessages = overview.messages?.total ?? overview.totalMessages ?? 0
      const totalDevices = overview.devices?.total ?? overview.totalDevices ?? 0
      const totalContacts = overview.contacts?.total ?? overview.totalContacts ?? 0

      if (overview.orphanedData?.messages > 0) issues.push(`${overview.orphanedData.messages} orphaned messages`)
      if (overview.orphanedData?.contacts > 0) issues.push(`${overview.orphanedData.contacts} orphaned contacts`)
      if (overview.orphanedData?.devices > 0) issues.push(`${overview.orphanedData.devices} orphaned devices`)
      if ((overview.users?.inactive30d ?? 0) > 10) issues.push(`${overview.users.inactive30d} inactive users (30d+)`)

      const transformed = {
        ...overview,
        totalUsers,
        totalMessages,
        totalDevices,
        totalContacts,
        databaseSize: overview.databaseSize || 'N/A',
        systemHealth: {
          status: issues.length === 0 ? 'healthy' : issues.length <= 2 ? 'warning' : 'critical',
          issues,
        },
      }
      setSystemOverview(transformed)
      addLog(`System overview loaded: ${totalUsers} users, ${totalMessages} messages, ${totalDevices} devices`)
    } catch (error) {
      addLog('Error loading system overview')
      console.error(error)
    } finally {
      setIsLoadingOverview(false)
    }
  }

  /**
   * Loads detailed cleanup overview with breakdown (OPTIMIZED)
   * Uses new backend function with 99% fewer database reads
   * - Old: 11,000+ reads for 1000 users
   * - New: <100 reads for any number of users
   * - 10x faster execution
   */
  const loadDetailedCleanupOverview = async (forceRefresh = false) => {
    setIsLoadingOverview(true)
    addLog('Loading detailed cleanup overview...')
    try {
      let overview: any
      try {
        overview = await vpsService.getAdminOverview()
      } catch {
        overview = await vpsService.getAdminStats()
      }
      const totalUsers = overview.users?.total ?? overview.totalUsers ?? 0
      const cleanupOverview = { totalCleanupItems: 0, totalUsers, categories: {} }
      setDetailedCleanupOverview(cleanupOverview)
      addLog(`Cleanup overview loaded: ${totalUsers} users`)
    } catch (error) {
      addLog(`Error loading cleanup overview: ${error}`)
      console.error(error)
    } finally {
      setIsLoadingOverview(false)
    }
  }

  /**
   * Loads detailed user list for the Users tab with pagination
   * Includes message counts, storage usage, plan info, and activity status
   */
  const loadDetailedUsers = async (page: number = currentPage) => {
    setIsLoadingUsers(true)
    setUsersError(null)
    try {
      const result = await vpsService.getAdminUsers({
        limit: pageSize,
        offset: page * pageSize,
        search: userSearchTerm || undefined,
      })
      // Normalize user objects to ensure all expected fields exist
      const normalizedUsers = (result.users || []).map((u: any) => ({
        userId: u.userId || u.id || '',
        messagesCount: u.messagesCount ?? u.messageCount ?? 0,
        devicesCount: u.devicesCount ?? u.deviceCount ?? 0,
        storageUsedMB: u.storageUsedMB ?? '0.00',
        plan: u.plan || 'free',
        planExpiresAt: u.planExpiresAt || null,
        planAssignedBy: u.planAssignedBy || null,
        wasPremium: u.wasPremium || false,
        lastActivity: u.lastActivity || u.lastSeen || null,
        isActive: u.isActive ?? true,
        phone: u.phone || null,
        email: u.email || null,
      }))
      setDetailedUsers(normalizedUsers)
      const totalPages = Math.ceil(result.total / pageSize)
      setTotalPages(totalPages)
      setTotalUserCount(result.total)
      setHasNextPage(page < totalPages - 1)
      setHasPrevPage(page > 0)
      setCurrentPage(page)
      setUsersError(null)
      addLog(`Loaded page ${page + 1}/${totalPages} (${normalizedUsers.length} users, ${result.total} total)`)
    } catch (error: any) {
      const msg = error?.message || String(error)
      setUsersError(msg)
      addLog(`Error loading users: ${msg}`)
      console.error('loadDetailedUsers error:', error)
    } finally {
      setIsLoadingUsers(false)
    }
  }

  /**
   * Navigate to next page of users
   */
  const goToNextPage = () => {
    if (hasNextPage) {
      loadDetailedUsers(currentPage + 1)
    }
  }

  /**
   * Navigate to previous page of users
   */
  const goToPrevPage = () => {
    if (hasPrevPage) {
      loadDetailedUsers(currentPage - 1)
    }
  }

  /**
   * Navigate to specific page of users
   */
  const goToPage = (page: number) => {
    if (page >= 0 && page < totalPages) {
      loadDetailedUsers(page)
    }
  }

  /**
   * Loads cost optimization recommendations based on current system state
   * Analyzes usage patterns and suggests actions to reduce costs
   */
  const loadCostRecommendations = async () => {
    // No-op for VPS mode; recommendations are generated client-side from data
    setCostRecommendations([])
  }

  /**
   * Loads cost & analytics data from VPS server
   */
  const loadCostMonitoring = async () => {
    setIsLoadingCosts(true)
    try {
      const [costs, bw, retention, dashboard, features] = await Promise.all([
        vpsService.getAdminAnalyticsCosts().catch(() => null),
        vpsService.getAdminAnalyticsBandwidth().catch(() => null),
        vpsService.getAdminAnalyticsRetention().catch(() => null),
        vpsService.getAdminAnalyticsDashboard().catch(() => null),
        vpsService.getAdminAnalyticsFeatures().catch(() => null),
      ])

      setCostEstimate(costs)
      setBandwidth(bw)
      setAnalyticsRetention(retention)
      setAnalyticsDashboard(dashboard)
      setAnalyticsFeatures(features?.features || [])
      addLog('VPS analytics data loaded')
    } catch (error) {
      addLog('Error loading analytics data')
      console.error(error)
    } finally {
      setIsLoadingCosts(false)
    }
  }

  // ============================================
  // USER MANAGEMENT HANDLERS
  // ============================================

  /**
   * Handles deletion of a single user account
   * Requires confirmation and logs the operation result
   *
   * @param userId - User ID to delete
   */
  const handleDeleteUser = async (userId: string) => {
    setConfirmDialog({
      open: true,
      title: 'Delete User Account?',
      message: `This will permanently delete user "${userId}" including:\n\nâ€¢ All messages\nâ€¢ All contacts\nâ€¢ All settings\nâ€¢ All storage\n\nThis action cannot be undone.`,
      confirmButtonText: 'Delete User',
      onConfirm: async () => {
        setDeletingUser(userId)
        setConfirmDialog(null)
        try {
          const result = await vpsService.deleteAdminUser(userId)
          if (result.success) {
            addLog(`User ${userId} deleted successfully: ${result.message}`)
            await loadSystemOverview()
            await loadDetailedUsers()
          } else {
            addLog(`Failed to delete user ${userId}: ${result.message}`)
          }
        } catch (error) {
          addLog(`Error deleting user ${userId}`)
          console.error(error)
        } finally {
          setDeletingUser(null)
        }
      }
    })
  }

  /**
   * Handles bulk deletion of inactive users
   * Deletes all users who haven't been active for 90+ days
   */
  const handleBulkDeleteInactive = async () => {
    setConfirmDialog({
      open: true,
      title: 'Delete Inactive Users?',
      message: 'This will permanently delete ALL users inactive for 90+ days.\n\nThis action cannot be undone.',
      confirmButtonText: 'Delete Inactive Users',
      onConfirm: async () => {
        setIsRunningBulkDelete(true)
        setConfirmDialog(null)
        try {
          const result = await vpsService.bulkDeleteInactiveUsers(90)
          addLog(`Bulk delete completed: ${result.deletedUsers} users deleted, ${result.freedStorageMB}MB storage freed`)
          await loadSystemOverview()
          await loadDetailedUsers()
        } catch (error) {
          addLog('Error during bulk delete')
          console.error(error)
        } finally {
          setIsRunningBulkDelete(false)
        }
      }
    })
  }

  /**
   * Implements a cost optimization recommendation
   * Routes to the appropriate cleanup function based on recommendation type
   *
   * @param recommendation - The recommendation to implement
   */
  const implementRecommendation = async (recommendation: CostRecommendation) => {
    const confirmMessage = `Are you sure you want to implement: "${recommendation.title}"?\n\n${recommendation.description}\n\nThis action may affect system performance and user data.`

    if (!confirm(confirmMessage)) {
      return
    }

    try {
      addLog(`Implementing: ${recommendation.title}`)

      switch (recommendation.type) {
        case 'cleanup':
          if (recommendation.title.includes('Inactive User')) {
            const result = await vpsService.bulkDeleteInactiveUsers(90)
            addLog(`Cleanup completed: ${result.deletedUsers} users deleted, ${result.freedStorageMB}MB storage freed`)
          } else {
            const cleanupResult = await vpsService.runAutoCleanup()
            const totalRecords = Object.values(cleanupResult.cleanupStats as Record<string, number>).reduce((a: number, b: number) => a + b, 0)
            addLog(`Cleanup completed: ${totalRecords} records removed`)

            if (cleanupResult.reportSent) {
              addLog(`âœ… Cleanup report generated and sent successfully`)
              addLog(`ðŸ“§ Email report sent to admin email`)
            } else {
              addLog(`ðŸ“ Cleanup report generated and logged to console`)
              if (cleanupResult.reportError?.includes('RESEND_API_KEY not configured')) {
                addLog(`ðŸ“§ To enable email reports, configure RESEND_API_KEY in Vercel environment variables`)
              } else {
                addLog(`âŒ Report sending failed: ${cleanupResult.reportError}`)
              }
            }
          }
          break
        default:
          addLog(`Implementation not yet available for: ${recommendation.type}`)
      }

      await loadSystemOverview()
      await loadCostRecommendations()
    } catch (error) {
      addLog(`Error implementing recommendation: ${error}`)
      console.error('Implementation error:', error)
    }
  }

  // ============================================
  // CLEANUP OPERATION HANDLERS
  // ============================================

  /**
   * Runs the comprehensive auto-cleanup operation
   * Cleans 12 categories of stale data and generates an email report
   *
   * CATEGORIES CLEANED:
   * - Outgoing messages, expired pairings, call requests
   * - Spam messages, read receipts, old devices
   * - Notifications, typing indicators, sessions
   * - File transfers, abandoned pairings, orphaned media
   */
  const handleAutoCleanup = async () => {
    if (!userId) {
      addLog('Cannot run cleanup: Admin authentication required')
      return
    }

    setIsRunningAuto(true)
    addLog('Starting auto cleanup with detailed email reporting...')

    try {
      const result = await vpsService.runAutoCleanup()
      const stats = result.cleanupStats
      const total = Object.values(stats as Record<string, number>).reduce((sum: number, count: number) => sum + count, 0)

      addLog(`Admin cleanup complete! Deleted ${total} records`)
      addLog(`  ðŸ“§ Outgoing messages: ${stats.outgoingMessages}`)
      addLog(`  ðŸ”— Expired pairings: ${stats.pendingPairings}`)
      addLog(`  ðŸ“ž Old call requests: ${stats.callRequests}`)
      addLog(`  ðŸ—‘ï¸ Old spam messages: ${stats.spamMessages}`)
      addLog(`  âœ… Old read receipts: ${stats.readReceipts}`)

      if (result.reportSent) {
        addLog(`âœ… Cleanup report generated and sent successfully`)
        addLog(`ðŸ“§ Email report sent to admin email`)
      } else {
        addLog(`ðŸ“ Cleanup report generated and logged to console`)
        if (result.reportError?.includes('RESEND_API_KEY not configured')) {
          addLog(`ðŸ“§ To enable email reports, configure RESEND_API_KEY in Vercel environment variables`)
        } else {
          addLog(`âŒ Report sending failed: ${result.reportError}`)
        }
      }
    } catch (error) {
      addLog('Error during admin cleanup')
      console.error(error)
    } finally {
      setIsRunningAuto(false)
    }
  }

  /**
   * Cleans up old and inactive device registrations
   * Removes devices that haven't been seen in 7+ days (except Android devices)
   */
  const handleDeviceCleanup = async () => {
    if (!userId) {
      addLog('Cannot run device cleanup: Authentication required')
      return
    }

    setIsRunningDeviceCleanup(true)
    addLog('Starting device cleanup...')

    try {
      const result = await vpsService.cleanupOldDevices()

      if (result.success) {
        addLog(`âœ… Device cleanup complete! Cleaned ${result.cleaned} old device entries`)
        addLog(`ðŸ“Š Found ${result.deviceInfo?.length || 0} total devices across all users`)

        if (result.deviceInfo && result.deviceInfo.length > 0) {
          addLog('ðŸ“‹ Device details:')
          result.deviceInfo.forEach((device: any) => {
            const status = result.devices?.some((d: any) => d.deviceId === device.deviceId) ? 'ðŸ—‘ï¸ REMOVED' : 'âœ… KEPT'
            const lastSeen = new Date(device.lastSeen).toLocaleString()
            addLog(`  ${status} ${device.deviceId} (${device.platform}) - Last seen: ${lastSeen} (${device.lastSeenHoursAgo}h ago)`)
          })
        }

        if (result.debug) {
          addLog(`ðŸ” Debug: ${result.debug.totalDevicesFound} devices found, ${result.debug.cleanedCount} cleaned, threshold: ${result.debug.thresholdHours}h`)
        }
      } else {
        addLog(`âŒ Device cleanup failed: ${result.message}`)
        if (result.error) {
          addLog(`   Error: ${result.error}`)
        }
      }
    } catch (error) {
      addLog('Error during device cleanup')
      console.error(error)
    } finally {
      setIsRunningDeviceCleanup(false)
    }
  }

  /**
   * Scans the database for orphaned nodes and inactive users
   * Provides counts and estimated cost savings if cleaned
   *
   * DETECTS:
   * - Empty user nodes (no data, 7+ days old)
   * - Orphaned users (no messages, 30+ days inactive)
   * - Stale data in various categories
   */
  const handleDetectOrphans = async () => {
    setIsDetectingOrphans(true)
    addLog('Scanning for orphaned nodes and users...')

    try {
      const counts = await vpsService.getOrphans()
      setOrphanCounts(counts)

      addLog('âœ… Orphan detection complete!')
      addLog(`ðŸ“Š Orphan Summary:`)
      addLog(`  ðŸ—‘ï¸ Empty user nodes (no data, 7+ days): ${counts.emptyUserNodes}`)
      addLog(`  ðŸ‘» Orphaned users (no messages, 30+ days): ${counts.orphanedUsers}`)
      addLog(`  ðŸ“§ Stale outgoing messages: ${counts.staleOutgoingMessages}`)
      addLog(`  ðŸ”— Expired pairings: ${counts.expiredPairings}`)
      addLog(`  ðŸ“ž Old call requests: ${counts.oldCallRequests}`)
      addLog(`  ðŸš« Old spam messages: ${counts.oldSpamMessages}`)
      addLog(`  âœ… Old read receipts: ${counts.oldReadReceipts}`)
      addLog(`  ðŸ“± Inactive devices: ${counts.inactiveDevices}`)
      addLog(`  ðŸ”” Old notifications: ${counts.oldNotifications}`)

      const totalOrphaned = counts.emptyUserNodes + counts.orphanedUsers
      const potentialSavings = (totalOrphaned * 0.002).toFixed(2) // Rough estimate: $0.002 per orphaned user/node
      addLog(`\nðŸ’° Potential monthly savings if cleaned: $${potentialSavings}`)
    } catch (error) {
      addLog(`âŒ Error detecting orphans: ${error}`)
      console.error(error)
    } finally {
      setIsDetectingOrphans(false)
    }
  }

  /**
   * Runs intelligent global cleanup with plan-based retention
   * Applies different retention policies for free vs paid users
   *
   * FREE TIER: Aggressive cleanup (14 days inactive)
   * PAID TIER: Longer retention (60 days inactive)
   */
  const handleSmartGlobalCleanup = async () => {
    if (!confirm('âš ï¸ This will delete all orphaned users and empty nodes.\n\nFree tier users inactive 14+ days will be removed.\nPaid users inactive 60+ days will be removed.\n\nAre you sure?')) {
      return
    }

    setIsRunningSmartCleanup(true)
    addLog('ðŸš€ Starting smart global cleanup...')

    try {
      const results = await vpsService.cleanupOrphans(true)

      addLog('âœ… Smart global cleanup complete!')
      addLog(`ðŸ“Š Cleanup Results:`)
      addLog(`  ðŸ‘¥ Users processed: ${results.usersProcessed}`)
      addLog(`  ðŸ—‘ï¸ Items cleaned per user: ${results.totalItemsCleaned}`)
      addLog(`  ðŸ‘» Empty nodes deleted: ${results.emptyNodesDeleted}`)
      addLog(`  ðŸ’€ Orphaned users deleted: ${results.orphanedUsersDeleted}`)
      addLog(`  ðŸ”„ Potential duplicate accounts detected: ${results.duplicatesDetected}`)

      const totalDeleted = results.emptyNodesDeleted + results.orphanedUsersDeleted
      const estimatedSavings = (totalDeleted * 0.005).toFixed(2) // $0.005 per deleted node
      addLog(`\nðŸ’° Estimated monthly savings: $${estimatedSavings}`)

      await loadSystemOverview()
      await loadDetailedUsers()
    } catch (error) {
      addLog(`âŒ Error during smart cleanup: ${error}`)
      console.error(error)
    } finally {
      setIsRunningSmartCleanup(false)
    }
  }

  /**
   * Detects duplicate user accounts created from the same device
   * Common cause: Device disconnect/reconnect cycles creating new accounts
   *
   * Results are stored in state for review before deletion
   */
  const handleDetectDuplicates = async () => {
    setIsDetectingDuplicates(true)
    addLog('Scanning for duplicate users on same device...')

    try {
      const duplicates = await vpsService.getDuplicates()
      setDuplicatesList(duplicates)

      // Calculate total duplicate accounts that can be deleted
      const totalDupes = duplicates.reduce((sum: number, d: any) => sum + (d.userIds.length - 1), 0)
      setTotalDuplicateAccounts(totalDupes)

      if (duplicates.length === 0) {
        addLog('âœ… No duplicate users found!')
      } else {
        addLog(`âš ï¸ Found ${duplicates.length} devices with multiple users:`)

        duplicates.forEach((dup: any, idx: number) => {
          const mergeCandidate = dup.potentialMergeCandidates ? 'ðŸ”´ LIKELY DUPLICATE' : 'ðŸŸ¡ POSSIBLE DUPLICATE'
          addLog(`\n  ${idx + 1}. Device: ${dup.deviceId.substring(0, 20)}...`)
          addLog(`     ${mergeCandidate}`)
          addLog(`     Users: ${dup.userIds.length}`)
          dup.userIds.forEach((uid: string) => {
            addLog(`       - ${uid.substring(0, 20)}...`)
          })
        })

        addLog(`\nðŸ’¡ Total duplicate accounts to delete: ${totalDupes}`)
        addLog(`ðŸ’° Cleanup could save: $${(totalDupes * 0.005).toFixed(2)}/month`)
      }
    } catch (error) {
      addLog(`âŒ Error detecting duplicates: ${error}`)
      console.error(error)
    } finally {
      setIsDetectingDuplicates(false)
    }
  }

  /**
   * Deletes duplicate user accounts detected by handleDetectDuplicates
   * Keeps the newest account per device and deletes older ones
   */
  const handleDeleteDuplicates = async () => {
    if (duplicatesList.length === 0) {
      addLog('âš ï¸ Please run "Detect Duplicates" first to identify accounts to delete')
      return
    }

    const totalDupes = duplicatesList.reduce((sum: number, d: any) => sum + (d.userIds.length - 1), 0)
    if (!confirm(`âš ï¸ This will DELETE ${totalDupes} duplicate accounts.\n\nWill keep the newest account per device and delete older ones.\n\nThis action CANNOT be undone. Are you sure?`)) {
      return
    }

    setIsDeletingDuplicates(true)
    addLog('ðŸ—‘ï¸ Starting deletion of duplicate users...')

    try {
      const result = await vpsService.cleanupOrphans(true) // cleanup duplicates via orphan cleanup

      if (result.success) {
        addLog('âœ… Duplicate deletion complete!')
        addLog(`ðŸ“Š Deletion Results:`)
        addLog(`  ðŸ—‘ï¸ Users deleted: ${result.deletedCount}`)
        addLog(`  ðŸ“± Devices cleaned: ${result.devicesProcessed}`)

        result.details.forEach((detail: any) => {
          addLog(`  ${detail}`)
        })

        const estimatedSavings = (result.deletedCount * 0.005).toFixed(2)
        addLog(`\nðŸ’° Estimated monthly savings: $${estimatedSavings}`)

        // Clear duplicates list and reload overview
        setDuplicatesList([])
        setTotalDuplicateAccounts(0)
        await loadSystemOverview()
        await loadDetailedUsers()
      } else {
        addLog(`âŒ Deletion failed: ${result.details.join(', ')}`)
      }
    } catch (error) {
      addLog(`âŒ Error during deletion: ${error}`)
      console.error(error)
    } finally {
      setIsDeletingDuplicates(false)
    }
  }

  /**
   * Deletes all user accounts that have no paired devices
   * These orphaned accounts cannot access their messages
   */
  const handleDeleteNoDeviceUsers = async () => {
    if (!confirm('âš ï¸ This will DELETE all users with no devices.\n\nThese orphaned accounts cannot access messages and are taking up storage.\n\nThis action CANNOT be undone. Are you sure?')) {
      return
    }

    setIsDeletingNoDeviceUsers(true)
    addLog('ðŸ—‘ï¸ Starting deletion of users without devices...')

    try {
      const result = await vpsService.cleanupOrphans(true)

      if (result.success) {
        addLog('âœ… User deletion complete!')
        addLog(`ðŸ“Š Deletion Results:`)
        addLog(`  ðŸ—‘ï¸ Users deleted: ${result.deletedCount}`)

        result.details.forEach((detail: any) => {
          addLog(`  ${detail}`)
        })

        const estimatedSavings = (result.deletedCount * 0.005).toFixed(2)
        addLog(`\nðŸ’° Estimated monthly savings: $${estimatedSavings}`)

        await loadSystemOverview()
        await loadDetailedUsers()
      } else {
        addLog(`âŒ Deletion failed: ${result.details.join(', ')}`)
      }
    } catch (error) {
      addLog(`âŒ Error during deletion: ${error}`)
      console.error(error)
    } finally {
      setIsDeletingNoDeviceUsers(false)
    }
  }

  /**
   * Deletes SMS messages older than retention periods
   * FREE TIER: 30 days, PAID TIER: 90 days
   */
  const handleDeleteOldMessages = async () => {
    if (!confirm('âš ï¸ This will DELETE all messages older than the retention period.\n\nFree tier: 30 days\nPaid tier: 90 days\n\nThis action CANNOT be undone. Are you sure?')) {
      return
    }

    setIsDeletingOldMessages(true)
    addLog('ðŸ—‘ï¸ Starting deletion of old messages...')

    try {
      const result = await vpsService.cleanupOldMessages(90)

      if (result.success) {
        addLog('âœ… Message cleanup complete!')
        addLog(`ðŸ“Š Deletion Results:`)
        addLog(`  ðŸ“¨ Total messages deleted: ${result.messagesDeleted}`)

        Object.entries(result.detailsByUser).forEach(([userId, count]) => {
          addLog(`  ${userId.substring(0, 20)}...: ${count} messages`)
        })

        // Estimate: ~500 bytes per message
        const savingsMB = (result.messagesDeleted * 0.0005).toFixed(2)
        const savingsMonthlyCost = (parseFloat(savingsMB) * 5 / 1024).toFixed(4) // $5 per GB per month
        addLog(`\nðŸ’¾ Storage freed: ~${savingsMB} MB`)
        addLog(`ðŸ’° Estimated monthly savings: $${savingsMonthlyCost}`)

        await loadSystemOverview()
      } else {
        addLog(`âŒ Message cleanup failed`)
      }
    } catch (error) {
      addLog(`âŒ Error during cleanup: ${error}`)
      console.error(error)
    } finally {
      setIsDeletingOldMessages(false)
    }
  }

  /**
   * Deletes MMS messages and attachments older than retention periods
   * FREE TIER: 7 days (aggressive to save storage)
   * PAID TIER: 90 days
   *
   * Also removes associated R2 storage files for attachments
   */
  const handleDeleteOldMms = async () => {
    if (!confirm('âš ï¸ This will DELETE all MMS messages older than the retention period.\n\nFree tier: 7 days (aggressive cleanup to save storage)\nPaid tier: 90 days\n\nAttachments (images, videos, etc.) will be permanently deleted.\n\nThis action CANNOT be undone. Are you sure?')) {
      return
    }

    setIsDeletingOldMms(true)
    addLog('ðŸ—‘ï¸ Starting deletion of old MMS messages...')

    try {
      const result = await vpsService.cleanupOldMessages(30, true)

      if (result.success) {
        addLog('âœ… MMS cleanup complete!')
        addLog(`ðŸ“Š Deletion Results:`)
        addLog(`  ðŸ“± Total MMS deleted: ${result.mmsDeleted}`)
        addLog(`  ðŸ“Ž Total attachments removed: ${result.r2FilesDeleted}`)

        Object.entries(result.detailsByUser).forEach(([userId, count]) => {
          addLog(`  ${userId.substring(0, 20)}...: ${count} MMS`)
        })

        // Estimate: ~2MB per MMS with attachments
        const savingsMB = (result.mmsDeleted * 2).toFixed(2)
        const savingsMonthlyCost = (parseFloat(savingsMB) * 5 / 1024).toFixed(4) // $5 per GB per month
        addLog(`\nðŸ’¾ Storage freed: ~${savingsMB} MB`)
        addLog(`ðŸ’° Estimated monthly savings: $${savingsMonthlyCost}`)

        await loadSystemOverview()
      } else {
        addLog(`âŒ MMS cleanup failed`)
      }
    } catch (error) {
      addLog(`âŒ Error during MMS cleanup: ${error}`)
      console.error(error)
    } finally {
      setIsDeletingOldMms(false)
    }
  }

  // ============================================
  // TESTING TAB HANDLERS
  // ============================================

  /**
   * Assigns a subscription plan to a user for testing purposes
   * Updates both usage path and subscription_records for persistence
   *
   * SUPPORTED PLANS: free, monthly, yearly, lifetime
   */
  const handleSetUserPlan = async () => {
    if (!testUserId.trim()) {
      addLog('âš ï¸ Please enter a User ID')
      return
    }

    setIsSettingPlan(true)
    addLog(`ðŸ”§ Assigning ${testPlan} plan to user ${testUserId}...`)

    try {
      const days = parseInt(testDaysValid) || 7
      const expiresAt = testPlan === 'lifetime' ? undefined :
        new Date(Date.now() + (days * 24 * 60 * 60 * 1000)).toISOString()

      const result = await vpsService.setUserPlan(testUserId, testPlan, expiresAt)
      if (result.success) {
        addLog(`User plan updated to ${testPlan}`)
        if (expiresAt) addLog(`Expires at: ${expiresAt}`)
      } else {
        addLog(`Failed to update plan`)
      }

      setTestUserId('')
      setTestPlan('free')
      setTestDaysValid('7')
    } catch (error: any) {
      addLog(`âŒ Error: ${error.message}`)
      console.error(error)
    } finally {
      setIsSettingPlan(false)
    }
  }

  /**
   * Enforces SMS-only messaging for free tier users
   * Removes calls, media, and other non-SMS content from free accounts
   * Significantly reduces storage costs for free tier
   */
  const handleEnforceSmsFree = async () => {
    if (!confirm('âš ï¸ This will REMOVE all non-SMS messages (calls, media, etc.) from FREE tier users.\n\nThis enforces SMS-only messaging for free accounts.\n\nPaid users will not be affected.\n\nThis action CANNOT be undone. Are you sure?')) {
      return
    }

    setIsEnforcingSms(true)
    addLog('ðŸ“± Starting SMS-only enforcement for free tier...')

    try {
      const result = await vpsService.cleanupOldMessages(30, true) // enforce SMS free via MMS cleanup

      if (result.success) {
        addLog('âœ… SMS enforcement complete!')
        addLog(`ðŸ“Š Results:`)
        addLog(`  ðŸ‘¥ Free users processed: ${result.usersProcessed}`)
        addLog(`  ðŸ—‘ï¸ Non-SMS messages removed: ${result.messagesRemoved}`)

        const savingsMB = (result.messagesRemoved * 0.001).toFixed(2)
        const savingsMonthlyCost = (parseFloat(savingsMB) * 5 / 1024).toFixed(4)
        addLog(`\nðŸ’¾ Storage freed: ~${savingsMB} MB`)
        addLog(`ðŸ’° Estimated monthly savings: $${savingsMonthlyCost}`)

        await loadSystemOverview()
      } else {
        addLog(`âŒ SMS enforcement failed`)
      }
    } catch (error) {
      addLog(`âŒ Error during enforcement: ${error}`)
      console.error(error)
    } finally {
      setIsEnforcingSms(false)
    }
  }

  // ============================================
  // DATABASE BROWSER HANDLERS
  // ============================================

  const loadDbTables = async () => {
    setIsLoadingDb(true)
    setDbError('')
    try {
      const data = await vpsService.getAdminTables()
      setDbTables(data.tables || [])
    } catch (err: any) {
      setDbError(err.message || 'Failed to load tables')
    } finally {
      setIsLoadingDb(false)
    }
  }

  const loadDbHealth = async () => {
    try {
      const data = await vpsService.getAdminDbHealth()
      setDbHealth(data)
    } catch {}
  }

  const loadDbTableSchema = async (tableName: string) => {
    try {
      const data = await vpsService.getAdminTableSchema(tableName)
      setDbSchema(data.columns || [])
    } catch {
      setDbSchema([])
    }
  }

  const loadDbTableData = async (tableName: string, page: number, sort?: string | null, sortDir?: 'ASC' | 'DESC', search?: string) => {
    setIsLoadingDbData(true)
    setDbError('')
    try {
      const data = await vpsService.getAdminTableData(tableName, {
        limit: dbPageSize,
        offset: page * dbPageSize,
        sort: sort || undefined,
        order: sortDir || 'DESC',
        search: search || undefined,
      })
      setDbRows(data.rows || [])
      setDbColumns(data.columns || [])
      setDbTotal(data.total || 0)
      setDbPage(page)
    } catch (err: any) {
      setDbError(err.message || 'Failed to load table data')
    } finally {
      setIsLoadingDbData(false)
    }
  }

  const openDbTable = (tableName: string) => {
    setDbSelectedTable(tableName)
    setDbSort(null)
    setDbSortDir('DESC')
    setDbSearch('')
    setDbPage(0)
    loadDbTableSchema(tableName)
    loadDbTableData(tableName, 0)
  }

  const closeDbTable = () => {
    setDbSelectedTable(null)
    setDbSchema([])
    setDbRows([])
    setDbColumns([])
    setDbTotal(0)
    setDbError('')
  }

  const handleDbColumnSort = (column: string) => {
    const newDir = dbSort === column ? (dbSortDir === 'ASC' ? 'DESC' : 'ASC') : 'DESC'
    setDbSort(column)
    setDbSortDir(newDir as 'ASC' | 'DESC')
    if (dbSelectedTable) loadDbTableData(dbSelectedTable, 0, column, newDir as 'ASC' | 'DESC', dbSearch)
  }

  const handleDbSearch = () => {
    if (dbSelectedTable) loadDbTableData(dbSelectedTable, 0, dbSort, dbSortDir, dbSearch)
  }

  const handleDbTableSort = (field: 'name' | 'estimatedRows' | 'totalSizeBytes') => {
    if (dbTableSortField === field) {
      setDbTableSortOrder(dbTableSortOrder === 'asc' ? 'desc' : 'asc')
    } else {
      setDbTableSortField(field)
      setDbTableSortOrder('desc')
    }
  }

  const sortedDbTables = [...dbTables]
    .filter(t => !dbTableFilter || t.name.toLowerCase().includes(dbTableFilter.toLowerCase()))
    .sort((a, b) => {
      const aVal = a[dbTableSortField]
      const bVal = b[dbTableSortField]
      if (typeof aVal === 'string' && typeof bVal === 'string') {
        return dbTableSortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal)
      }
      return dbTableSortOrder === 'asc' ? (aVal as number) - (bVal as number) : (bVal as number) - (aVal as number)
    })

  const dbTotalPages = Math.ceil(dbTotal / dbPageSize)

  const runDbQuery = async () => {
    if (!dbSqlQuery.trim()) return
    setDbQueryLoading(true)
    setDbQueryError('')
    setDbQueryResult(null)
    try {
      const result = await vpsService.runAdminQuery(dbSqlQuery)
      setDbQueryResult(result)
    } catch (err: any) {
      setDbQueryError(err.message || 'Query failed')
    } finally {
      setDbQueryLoading(false)
    }
  }

  const dbGetPrimaryKey = (): string | null => {
    const pk = dbSchema.find(c => c.isPrimaryKey)
    return pk?.name || null
  }

  const dbStartEdit = (row: any) => {
    setDbEditingRow(row)
    setDbEditValues({ ...row })
    setDbEditError('')
  }

  const dbSaveEdit = async () => {
    const pk = dbGetPrimaryKey()
    if (!pk || !dbSelectedTable || !dbEditingRow) return
    setDbEditLoading(true)
    setDbEditError('')
    try {
      await vpsService.updateAdminTableRow(dbSelectedTable, dbEditingRow[pk], dbEditValues)
      setDbEditingRow(null)
      loadDbTableData(dbSelectedTable, dbPage, dbSort, dbSortDir, dbSearch)
    } catch (err: any) {
      setDbEditError(err.message || 'Update failed')
    } finally {
      setDbEditLoading(false)
    }
  }

  const dbConfirmDelete = async () => {
    const pk = dbGetPrimaryKey()
    if (!pk || !dbSelectedTable || !dbDeletingRow) return
    setDbDeleteLoading(true)
    try {
      await vpsService.deleteAdminTableRow(dbSelectedTable, dbDeletingRow[pk])
      setDbDeletingRow(null)
      loadDbTableData(dbSelectedTable, dbPage, dbSort, dbSortDir, dbSearch)
    } catch (err: any) {
      setDbError(err.message || 'Delete failed')
    } finally {
      setDbDeleteLoading(false)
    }
  }

  // ============================================
  // R2 STORAGE HANDLERS
  // ============================================

  /**
   * Loads R2 storage analytics including file counts, sizes, and user breakdown
   */
  const loadR2Analytics = async () => {
    setIsLoadingR2(true)
    addLog('Loading R2 storage analytics...')
    try {
      const analytics = await vpsService.getR2Analytics()
      setR2Analytics(analytics)
      addLog(`R2 Analytics loaded: ${analytics.totalFiles} files, ${(analytics.totalSize / (1024 * 1024)).toFixed(2)}MB total`)
    } catch (error) {
      addLog(`Error loading R2 analytics: ${error}`)
      console.error(error)
    } finally {
      setIsLoadingR2(false)
    }
  }

  /**
   * Loads a paginated list of R2 files with optional type filtering
   */
  const loadR2FileList = async () => {
    setIsLoadingR2(true)
    try {
      const filterType = r2FileTypeFilter === 'all' ? undefined : r2FileTypeFilter
      const result = await vpsService.getR2Files({ type: filterType, limit: 50 })
      setR2FileList(result.files)
      addLog(`Loaded ${result.files.length} R2 files (${result.totalCount} total)`)
    } catch (error) {
      addLog(`Error loading R2 file list: ${error}`)
      console.error(error)
    } finally {
      setIsLoadingR2(false)
    }
  }

  /**
   * Loads all crash reports and statistics (OPTIMIZED)
   * Uses consolidated endpoint - 1 API call instead of 2
   */
  const loadCrashReports = async () => {
    setIsLoadingCrashes(true)
    addLog('Loading crash reports...')
    try {
      const result = await vpsService.getCrashReports({ limit: 100 })

      // Map the crash data to match the existing CrashReport interface
      const mappedCrashes = result.crashes.map((crash: any) => ({
        id: crash.crashId || crash.id || '',
        userId: crash.userId || null,
        isFatal: crash.isFatal || false,
        context: crash.context || '',
        timestamp: crash.timestamp || 0,
        timestampFormatted: crash.timestampFormatted || new Date(crash.timestamp).toLocaleString(),
        exceptionType: crash.exceptionType || crash.errorType || 'Unknown',
        exceptionMessage: crash.exceptionMessage || crash.errorMessage || '',
        stackTrace: crash.stackTrace || '',
        cause: crash.cause,
        appVersion: crash.appVersion || '',
        appVersionCode: crash.appVersionCode || 0,
        buildType: crash.buildType || '',
        deviceManufacturer: crash.deviceInfo?.manufacturer || crash.deviceManufacturer || '',
        deviceModel: crash.deviceInfo?.model || crash.deviceModel || '',
        deviceBrand: crash.deviceInfo?.brand || crash.deviceBrand || '',
        androidVersion: crash.deviceInfo?.androidVersion || crash.androidVersion || '',
        androidSdkInt: crash.deviceInfo?.androidSdkInt || crash.androidSdkInt || 0,
        deviceId: crash.deviceInfo?.deviceId || crash.deviceId || '',
        resolved: crash.resolved || false,
        resolvedBy: crash.resolvedBy,
        resolvedAt: crash.resolvedAt,
        notes: crash.notes
      }))

      setCrashReports(mappedCrashes)

      // Map statistics to match the existing CrashStats interface
      if (result.statistics) {
        const mappedStats = {
          totalCrashes: result.statistics.totalCrashes || 0,
          fatalCrashes: result.statistics.fatalCrashes || 0,
          nonFatalCrashes: (result.statistics.totalCrashes || 0) - (result.statistics.fatalCrashes || 0),
          unresolvedCrashes: result.statistics.unresolvedCrashes || 0,
          uniqueUsers: result.statistics.affectedUsers || 0,
          anonymousCrashes: 0, // Not provided by new endpoint
          topExceptions: (result.statistics.topCrashReasons || []).map((item: any) => ({
            type: item.reason || '',
            count: item.count || 0
          })),
          crashesByDevice: [], // Not provided by new endpoint
          crashesByVersion: [] // Not provided by new endpoint
        }
        setCrashStats(mappedStats)
      }

      addLog(
        `Loaded ${mappedCrashes.length} crash reports ` +
        `(${result.statistics?.unresolvedCrashes || 0} unresolved) - ` +
        `OPTIMIZED: 1 API call instead of 2!`
      )
    } catch (error) {
      addLog(`Error loading crash reports: ${error}`)
      console.error(error)
    } finally {
      setIsLoadingCrashes(false)
    }
  }

  /**
   * Marks a crash as resolved
   */
  const handleResolveCrash = async (crash: CrashReport, notes?: string) => {
    if (!crash.id) return

    setResolvingCrash(crash.id)
    addLog(`Marking crash ${crash.id} as resolved...`)
    try {
      await vpsService.deleteCrashReport(crash.id) // VPS: resolve = delete
      addLog(`Crash ${crash.id} marked as resolved`)
      await loadCrashReports()
    } catch (error) {
      addLog(`Error resolving crash: ${error}`)
      console.error(error)
    } finally {
      setResolvingCrash(null)
    }
  }

  /**
   * Deletes a crash report
   */
  const handleDeleteCrash = async (crash: CrashReport) => {
    if (!crash.id) return

    if (!confirm(`Are you sure you want to delete this crash report?\n\nException: ${crash.exceptionType}\n\nThis action cannot be undone.`)) {
      return
    }

    setDeletingCrash(crash.id)
    addLog(`Deleting crash ${crash.id}...`)
    try {
      await vpsService.deleteCrashReport(crash.id)
      addLog(`Crash ${crash.id} deleted`)
      await loadCrashReports()
      if (selectedCrash?.id === crash.id) {
        setSelectedCrash(null)
      }
    } catch (error) {
      addLog(`Error deleting crash: ${error}`)
      console.error(error)
    } finally {
      setDeletingCrash(null)
    }
  }

  /**
   * Cleans up R2 files older than specified days
   * Can be filtered by file type (files, mms, photos)
   */
  const handleCleanupR2Files = async () => {
    const days = parseInt(r2CleanupDays)
    if (isNaN(days) || days < 1) {
      addLog('Invalid days threshold')
      return
    }

    if (!confirm(`Are you sure you want to delete all R2 files older than ${days} days?\n\nThis action cannot be undone.`)) {
      return
    }

    setIsCleaningR2(true)
    addLog(`Starting R2 cleanup for files older than ${days} days...`)

    try {
      const filterType = r2FileTypeFilter === 'all' ? undefined : r2FileTypeFilter
      const result = await vpsService.cleanupR2Files(days, filterType)

      if (result.success) {
        addLog(`R2 cleanup complete: ${JSON.stringify(result.results)}`)
        await loadR2Analytics()
      } else {
        addLog(`R2 cleanup failed: ${result.errors.join(', ')}`)
      }
    } catch (error) {
      addLog(`Error during R2 cleanup: ${error}`)
      console.error(error)
    } finally {
      setIsCleaningR2(false)
    }
  }

  /**
   * Deletes a single R2 file by its key
   * @param r2Key - The R2 storage key for the file to delete
   */
  const handleDeleteR2File = async (r2Key: string) => {
    if (!confirm(`Delete file: ${r2Key}?\n\nThis action cannot be undone.`)) {
      return
    }

    setDeletingR2File(r2Key)
    try {
      const result = await vpsService.deleteR2File(r2Key)
      if (result.success) {
        addLog(`Deleted R2 file: ${r2Key}`)
        setR2FileList(prev => prev.filter((f: any) => f.r2Key !== r2Key))
        await loadR2Analytics()
      } else {
        addLog(`Failed to delete R2 file: ${result.error}`)
      }
    } catch (error) {
      addLog(`Error deleting R2 file: ${error}`)
    } finally {
      setDeletingR2File(null)
    }
  }

  /**
   * Recalculates storage usage for a specific user
   * Useful when storage tracking gets out of sync
   * @param targetUserId - User ID to recalculate storage for
   */
  const handleRecalculateStorage = async (targetUserId: string) => {
    setRecalculatingUser(targetUserId)
    try {
      const result = await vpsService.recalculateUserStorage(targetUserId)
      if (result.success) {
        const totalMB = (result.storage.totalStorageBytes / (1024 * 1024)).toFixed(2)
        addLog(`Recalculated storage for ${targetUserId.slice(0, 8)}...: ${totalMB}MB total`)
        await loadR2Analytics() // Refresh to show updated values
      } else {
        addLog(`Failed to recalculate storage: ${result.error}`)
      }
    } catch (error) {
      addLog(`Error recalculating storage: ${error}`)
    } finally {
      setRecalculatingUser(null)
    }
  }

  /**
   * Scans for and optionally deletes orphaned R2 files
   * @param dryRun - If true, only reports orphaned files without deleting
   */
  const handleCleanupOrphanedR2 = async (dryRun: boolean = true) => {
    const action = dryRun ? 'Scanning' : 'Cleaning up'
    setIsCleaningOrphaned(true)
    addLog(`${action} orphaned R2 files...`)

    try {
      const result = await vpsService.cleanupOrphans(false) as any // cleanup orphaned R2 via orphan cleanup

      if (result.success) {
        const sizeMB = (result.freedBytes / (1024 * 1024)).toFixed(2)
        setOrphanedFileCount(result.totalOrphaned)
        setOrphanedFileSize(result.freedBytes)

        if (dryRun) {
          addLog(`Found ${result.totalOrphaned} orphaned files (~${sizeMB}MB)`)
          if (result.totalOrphaned > 0) {
            addLog(`  â†’ Click "Delete Orphaned Files" to permanently remove them`)
          }
        } else {
          addLog(`Deleted ${result.deletedCount} orphaned files, freed ${sizeMB}MB`)
          await loadR2Analytics() // Refresh analytics
        }
      } else {
        addLog(`Orphaned file cleanup failed: ${result.message}`)
      }
    } catch (error) {
      addLog(`Error cleaning up orphaned files: ${error}`)
    } finally {
      setIsCleaningOrphaned(false)
    }
  }

  /**
   * Handles admin logout
   * Clears localStorage session and redirects to login page
   */
  const handleLogout = () => {
    localStorage.removeItem('syncflow_admin_session')
    localStorage.removeItem('syncflow_user_id')
    router.push('/admin/login')
  }

  // ============================================
  // INITIALIZATION AND EFFECTS
  // ============================================

  /**
   * Initializes the admin panel on mount
   * 1. Validates localStorage session
   * 2. Waits for Firebase Auth state
   * 3. Verifies admin claim in token
   * 4. Loads initial data if authorized
   */
  useEffect(() => {
    console.log('AdminCleanupPage: Initializing...')

    // Check localStorage session first
    if (!isValidAdminSession()) {
      console.log('AdminCleanupPage: No valid session, redirecting to login')
      router.push('/admin/login')
      return
    }

    // VPS mode: skip Firebase auth, use localStorage session directly
    const isVPS = !!process.env.NEXT_PUBLIC_VPS_URL || !!localStorage.getItem('vps_access_token')
    if (isVPS) {
      console.log('AdminCleanupPage: VPS mode - using session auth')
      const storedUserId = localStorage.getItem('syncflow_user_id') || localStorage.getItem('vps_user_id') || 'admin'
      setIsAuthorized(true)
      setUserId(storedUserId)
      setIsLoading(false)
      addLog('Admin panel initialized (VPS mode)')

      loadSystemOverview().catch(error => {
        console.error('System overview error:', error)
        addLog('Failed to load system overview')
      })

      loadDetailedCleanupOverview().catch(error => {
        console.error('Detailed cleanup overview error:', error)
        addLog('Failed to load detailed cleanup overview')
      })
      return
    }

    // No VPS token found - redirect to login
    console.log('AdminCleanupPage: No VPS session, redirecting to login')
    setIsLoading(false)
    setIsAuthorized(false)
    localStorage.removeItem('syncflow_admin_session')
    router.push('/admin/login')
  }, [router])

  /**
   * Auto-scrolls the activity log container when new entries are added
   * Ensures users can see the most recent activity
   */
  useEffect(() => {
    logContainerRef.current?.scrollTo({ top: 0, behavior: 'smooth' })
  }, [cleanupLog])

  // ============================================
  // RENDER: LOADING STATE
  // ============================================
  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-900 flex items-center justify-center">
        <Loader2 className="w-8 h-8 text-blue-500 animate-spin" />
      </div>
    )
  }

  // ============================================
  // RENDER: UNAUTHORIZED STATE
  // ============================================
  if (!isAuthorized) {
    return (
      <div className="min-h-screen bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <ShieldX className="w-16 h-16 text-red-500 mx-auto mb-4" />
          <h1 className="text-2xl font-bold text-white mb-2">Access Denied</h1>
          <p className="text-gray-400 mb-6">You do not have permission to access this page.</p>
          <button
            onClick={() => router.push('/messages')}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            Go to Messages
          </button>
        </div>
      </div>
    )
  }

  // ============================================
  // RENDER: MAIN ADMIN DASHBOARD
  // ============================================
  return (
    <div className="h-screen bg-gray-900 text-white overflow-hidden flex flex-col">
      {/* ==================== HEADER ==================== */}
      <div className="flex items-center justify-between p-6 border-b border-gray-800">
        <div className="flex items-center gap-3">
          <Shield className="w-8 h-8 text-blue-500" />
          <div>
            <h1 className="text-2xl font-bold">SyncFlow Admin Dashboard</h1>
            <p className="text-gray-400 text-sm">Comprehensive system management and cost optimization</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={async () => {
              // cache cleared // Clear cache to force fresh data
              await loadSystemOverview()
              await loadDetailedUsers()
              await loadCostRecommendations()
              addLog('Dashboard data refreshed (cache cleared)')
            }}
            className="flex items-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors"
          >
            <RefreshCw className="w-4 h-4" />
            Refresh All
          </button>
          <button
            onClick={handleLogout}
            className="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors"
          >
            <LogOut className="w-4 h-4" />
            Logout
          </button>
        </div>
      </div>

      {/* ==================== NAVIGATION TABS ====================
          Each tab loads its data lazily when first selected */}
      <div className="flex overflow-x-auto flex-nowrap border-b border-gray-800 px-6">
        {[
          { id: 'overview', label: 'Overview', icon: BarChart3 },
          { id: 'lookup', label: 'Lookup', icon: Search },
          { id: 'live', label: 'Live', icon: Wifi },
          { id: 'logs', label: 'Logs', icon: ScrollText },
          { id: 'users', label: 'Users', icon: Users },
          { id: 'data', label: 'Data & Cleanup', icon: Database },
          { id: 'storage', label: 'R2 Storage', icon: Cloud },
          { id: 'crashes', label: 'Crash Reports', icon: AlertTriangle },
          { id: 'costs', label: 'Costs & Analytics', icon: DollarSign },
          { id: 'database', label: 'Database', icon: HardDrive },
          { id: 'monitoring', label: 'Performance Monitor', icon: LineChart },
          { id: 'testing', label: 'Testing', icon: Zap },
        ].map(({ id, label, icon: Icon }) => (
          <button
            key={id}
            onClick={() => {
              setActiveTab(id as any)
              if (id === 'overview' && !systemOverview) loadSystemOverview()
              if (id === 'overview') { loadAlerts(); loadMaintenanceStatus(); vpsService.getAdminSessions().then(s => setOnlineCount(s.onlineCount)).catch(() => {}) }
              if (id === 'lookup') { /* no auto-load */ }
              if (id === 'live') loadLiveSessions()
              if (id === 'logs') loadServerLogs()
              if (id === 'users' && detailedUsers.length === 0 && totalUserCount === 0) loadDetailedUsers(0)
              if (id === 'costs' && costRecommendations.length === 0) loadCostRecommendations()
              if (id === 'storage' && !r2Analytics) loadR2Analytics()
              if (id === 'crashes' && crashReports.length === 0) loadCrashReports()
              if (id === 'database' && dbTables.length === 0) { loadDbTables(); loadDbHealth() }
            }}
            className={`flex-shrink-0 flex items-center gap-2 px-4 py-3 border-b-2 font-medium text-sm transition-colors whitespace-nowrap ${
              activeTab === id
                ? 'border-blue-500 text-blue-400'
                : 'border-transparent text-gray-400 hover:text-gray-300'
            }`}
          >
            <Icon className="w-4 h-4" />
            {label}
          </button>
        ))}
      </div>

      {/* ==================== TAB CONTENT ====================
          Conditionally renders based on activeTab state */}
      <div className="flex-1 overflow-y-auto p-6">
        {/* ========== OVERVIEW TAB ========== */}
        {activeTab === 'overview' && (
          <div className="space-y-6">
            <div className="bg-gray-800 rounded-xl p-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold">System Health</h2>
                <button onClick={loadSystemOverview} disabled={isLoadingOverview} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg transition-colors">
                  {isLoadingOverview ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />}
                  {isLoadingOverview ? 'Loading...' : 'Refresh'}
                </button>
              </div>

              {systemOverview && (
                <>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div className="bg-gray-700 rounded-lg p-6">
                      <div className="flex items-center gap-2 mb-2">
                        <Users className="w-6 h-6 text-green-500" />
                        <span className="text-sm font-medium">Total Users</span>
                      </div>
                      <p className="text-3xl font-bold">{systemOverview.totalUsers}</p>
                      <p className="text-xs text-gray-400 mt-2">Registered user accounts</p>
                    </div>

                    <div className={`bg-gray-700 rounded-lg p-6 border-l-4 ${
                      systemOverview.systemHealth.status === 'healthy' ? 'border-green-500' :
                      systemOverview.systemHealth.status === 'warning' ? 'border-yellow-500' :
                      'border-red-500'
                    }`}>
                      <div className="flex items-center gap-2 mb-2">
                        <Activity className={`w-6 h-6 ${
                          systemOverview.systemHealth.status === 'healthy' ? 'text-green-500' :
                          systemOverview.systemHealth.status === 'warning' ? 'text-yellow-500' :
                          'text-red-500'
                        }`} />
                        <span className="text-sm font-medium">System Status</span>
                      </div>
                      <p className="text-2xl font-bold capitalize">{systemOverview.systemHealth.status}</p>
                      {systemOverview.systemHealth.issues.length > 0 && (
                        <ul className="text-xs text-gray-400 mt-2 space-y-1">
                          {systemOverview.systemHealth.issues.map((issue: any, idx: number) => (
                            <li key={idx}>â€¢ {issue}</li>
                          ))}
                        </ul>
                      )}
                    </div>
                  </div>

                  <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                      <MessageSquare className="w-5 h-5 text-blue-400 mt-0.5" />
                      <div>
                        <p className="text-sm font-medium text-blue-300 mb-1">
                          Detailed User Analytics
                        </p>
                        <p className="text-xs text-gray-400">
                          For per-user message counts, storage usage, activity status, and plan details, visit the <button onClick={() => setActiveTab('users')} className="text-blue-400 hover:text-blue-300 underline font-medium">Users tab</button>.
                          The Overview tab now uses minimal bandwidth to provide quick system health checks.
                        </p>
                      </div>
                    </div>
                  </div>
                </>
              )}
            </div>

            {/* Quick Stats Row */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="bg-gray-800 rounded-xl p-4 flex items-center gap-4">
                <Wifi className="w-8 h-8 text-green-400" />
                <div>
                  <p className="text-sm text-gray-400">Online Now</p>
                  <p className="text-2xl font-bold">{onlineCount ?? 'â€”'}</p>
                </div>
              </div>
              <div className="bg-gray-800 rounded-xl p-4 flex items-center gap-4">
                <Key className="w-8 h-8 text-purple-400" />
                <div>
                  <p className="text-sm text-gray-400">E2EE Keys</p>
                  <p className="text-2xl font-bold">{e2eeHealth?.totalKeys ?? 'â€”'}</p>
                </div>
              </div>
              <div className="bg-gray-800 rounded-xl p-4 flex items-center gap-4">
                <Power className={`w-8 h-8 ${maintenanceEnabled ? 'text-yellow-400' : 'text-gray-500'}`} />
                <div>
                  <p className="text-sm text-gray-400">Maintenance</p>
                  <p className="text-2xl font-bold">{maintenanceEnabled ? 'ON' : 'OFF'}</p>
                </div>
              </div>
            </div>

            {/* Maintenance Mode Toggle */}
            <div className="bg-gray-800 rounded-xl p-6">
              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                <Power className="w-5 h-5" /> Maintenance Mode
              </h3>
              <div className="flex flex-col sm:flex-row gap-4">
                <input
                  type="text"
                  placeholder="Maintenance message (shown to users)..."
                  value={maintenanceMessage}
                  onChange={e => setMaintenanceMessage(e.target.value)}
                  className="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400"
                />
                <button
                  onClick={toggleMaintenance}
                  disabled={isTogglingMaintenance}
                  className={`px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2 ${
                    maintenanceEnabled
                      ? 'bg-green-600 hover:bg-green-700'
                      : 'bg-yellow-600 hover:bg-yellow-700'
                  } disabled:opacity-50`}
                >
                  {isTogglingMaintenance ? <Loader2 className="w-4 h-4 animate-spin" /> : <Power className="w-4 h-4" />}
                  {maintenanceEnabled ? 'Disable Maintenance' : 'Enable Maintenance'}
                </button>
              </div>
              {maintenanceEnabled && (
                <p className="mt-3 text-sm text-yellow-300 bg-yellow-900/30 border border-yellow-700/50 rounded-lg px-4 py-2">
                  Maintenance mode is active. All non-admin API requests are returning 503.
                </p>
              )}
            </div>

            {/* System Alerts */}
            <div className="bg-gray-800 rounded-xl p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold flex items-center gap-2">
                  <AlertCircle className="w-5 h-5" /> System Alerts
                </h3>
                <button onClick={loadAlerts} disabled={isLoadingAlerts} className="flex items-center gap-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
                  {isLoadingAlerts ? <Loader2 className="w-3 h-3 animate-spin" /> : <RefreshCw className="w-3 h-3" />}
                  Refresh
                </button>
              </div>
              {systemAlerts.length === 0 ? (
                <p className="text-gray-500 text-sm">No alerts. System is healthy.</p>
              ) : (
                <div className="space-y-3">
                  {systemAlerts.map((alert: any, idx: number) => (
                    <div key={idx} className={`rounded-lg p-4 border ${
                      alert.severity === 'critical' ? 'bg-red-900/30 border-red-700 text-red-300' :
                      alert.severity === 'warning' ? 'bg-yellow-900/30 border-yellow-700 text-yellow-300' :
                      'bg-blue-900/30 border-blue-700 text-blue-300'
                    }`}>
                      <p className="font-medium text-sm">{alert.title}</p>
                      <p className="text-xs mt-1 opacity-80">{alert.message}</p>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* ========== LOOKUP TAB ========== */}
        {activeTab === 'lookup' && (
          <div className="space-y-6">
            <div className="bg-gray-800 rounded-xl p-6">
              <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                <Search className="w-5 h-5" /> User Lookup
              </h2>
              <div className="flex gap-3 mb-4">
                <input
                  type="text"
                  placeholder="Search by email, phone, uid, or firebase_uid..."
                  value={lookupQuery}
                  onChange={e => setLookupQuery(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && loadLookup()}
                  className="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400"
                />
                <button
                  onClick={loadLookup}
                  disabled={isLoadingLookup || !lookupQuery.trim()}
                  className="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg font-medium flex items-center gap-2"
                >
                  {isLoadingLookup ? <Loader2 className="w-4 h-4 animate-spin" /> : <Search className="w-4 h-4" />}
                  Search
                </button>
              </div>
              {lookupError && <p className="text-red-400 text-sm mb-4">{lookupError}</p>}
            </div>

            {lookupResults.map((user: any) => (
              <div key={user.uid} className="bg-gray-800 rounded-xl p-6">
                <div className="flex items-start justify-between mb-4">
                  <div>
                    <h3 className="text-lg font-semibold">{user.phone || user.email || user.uid}</h3>
                    <p className="text-sm text-gray-400 font-mono">{user.uid}</p>
                  </div>
                  <span className="text-xs bg-gray-700 px-3 py-1 rounded-full">{user.messageCount} messages</span>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                  <div className="bg-gray-700/50 rounded-lg p-3">
                    <p className="text-xs text-gray-400">Phone</p>
                    <p className="text-sm font-medium">{user.phone || 'â€”'}</p>
                  </div>
                  <div className="bg-gray-700/50 rounded-lg p-3">
                    <p className="text-xs text-gray-400">Email</p>
                    <p className="text-sm font-medium">{user.email || 'â€”'}</p>
                  </div>
                  <div className="bg-gray-700/50 rounded-lg p-3">
                    <p className="text-xs text-gray-400">Created</p>
                    <p className="text-sm font-medium">{new Date(user.createdAt).toLocaleDateString()}</p>
                  </div>
                  <div className="bg-gray-700/50 rounded-lg p-3">
                    <p className="text-xs text-gray-400">Last Active</p>
                    <p className="text-sm font-medium">{user.lastActivity ? new Date(user.lastActivity).toLocaleString() : 'â€”'}</p>
                  </div>
                </div>

                {user.devices && user.devices.length > 0 && (
                  <div>
                    <p className="text-sm font-medium text-gray-400 mb-2">Devices ({user.devices.length})</p>
                    <div className="space-y-2">
                      {user.devices.map((dev: any) => (
                        <div key={dev.id} className="flex items-center justify-between bg-gray-700/30 rounded-lg px-4 py-2">
                          <div className="flex items-center gap-3">
                            <span className={`inline-block w-2 h-2 rounded-full ${
                              new Date(dev.lastSeen).getTime() > Date.now() - 5 * 60 * 1000 ? 'bg-green-400' : 'bg-gray-500'
                            }`} />
                            <span className="text-sm">{dev.name || dev.type}</span>
                            <span className="text-xs text-gray-500">{dev.type}</span>
                          </div>
                          <span className="text-xs text-gray-400">{new Date(dev.lastSeen).toLocaleString()}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        )}

        {/* ========== LIVE TAB ========== */}
        {activeTab === 'live' && (
          <div className="space-y-6">
            <div className="bg-gray-800 rounded-xl p-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold flex items-center gap-2">
                  <Wifi className="w-5 h-5 text-green-400" /> Live Sessions
                </h2>
                <button
                  onClick={loadLiveSessions}
                  disabled={isLoadingLive}
                  className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg"
                >
                  {isLoadingLive ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />}
                  Refresh
                </button>
              </div>

              {liveSessions && (
                <div className="space-y-4">
                  <div className="flex items-center gap-3 text-3xl font-bold">
                    <span className="inline-block w-3 h-3 rounded-full bg-green-400 animate-pulse" />
                    {liveSessions.onlineCount} online
                  </div>

                  {liveSessions.users && liveSessions.users.length > 0 ? (
                    <div className="space-y-3">
                      {liveSessions.users.map((u: any) => (
                        <div key={u.uid} className="bg-gray-700/50 rounded-lg p-4 flex items-center justify-between">
                          <div>
                            <p className="font-mono text-sm">{u.uid.slice(0, 12)}...</p>
                            <p className="text-xs text-gray-400">WS connections: {u.wsDeviceCount}</p>
                          </div>
                          <div className="flex gap-2">
                            {u.devices.map((d: any) => (
                              <span key={d.id} className="text-xs bg-gray-600 px-2 py-1 rounded">
                                {d.name || d.type}
                              </span>
                            ))}
                            {u.devices.length === 0 && u.wsDevices.map((id: string) => (
                              <span key={id} className="text-xs bg-gray-600 px-2 py-1 rounded font-mono">
                                {id.slice(0, 8)}
                              </span>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-gray-500 text-sm">No users currently online</p>
                  )}
                </div>
              )}
            </div>

            {/* E2EE Health Summary */}
            {e2eeHealth && (
              <div className="bg-gray-800 rounded-xl p-6">
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <Key className="w-5 h-5 text-purple-400" /> E2EE Key Health
                </h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-gray-700/50 rounded-lg p-4 text-center">
                    <p className="text-2xl font-bold text-purple-400">{e2eeHealth.totalKeys}</p>
                    <p className="text-xs text-gray-400">Total Keys</p>
                  </div>
                  <div className="bg-gray-700/50 rounded-lg p-4 text-center">
                    <p className="text-2xl font-bold text-green-400">{e2eeHealth.usersWithKeys}</p>
                    <p className="text-xs text-gray-400">Users With Keys</p>
                  </div>
                  <div className="bg-gray-700/50 rounded-lg p-4 text-center">
                    <p className={`text-2xl font-bold ${e2eeHealth.usersWithout > 0 ? 'text-yellow-400' : 'text-gray-500'}`}>{e2eeHealth.usersWithout}</p>
                    <p className="text-xs text-gray-400">Users Without Keys</p>
                  </div>
                  <div className="bg-gray-700/50 rounded-lg p-4 text-center">
                    <p className={`text-2xl font-bold ${e2eeHealth.staleKeys > 0 ? 'text-orange-400' : 'text-gray-500'}`}>{e2eeHealth.staleKeys}</p>
                    <p className="text-xs text-gray-400">Stale Keys (30d+)</p>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* ========== LOGS TAB ========== */}
        {activeTab === 'logs' && (
          <div className="space-y-4">
            <div className="bg-gray-800 rounded-xl p-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold flex items-center gap-2">
                  <ScrollText className="w-5 h-5" /> Server Logs
                  <span className="text-sm font-normal text-gray-400">({logsTotal} total)</span>
                </h2>
                <div className="flex gap-2">
                  <button
                    onClick={async () => { await vpsService.clearAdminLogs(); loadServerLogs() }}
                    className="px-3 py-1.5 bg-red-600/30 hover:bg-red-600/50 border border-red-700 rounded-lg text-sm text-red-300"
                  >
                    Clear
                  </button>
                  <button
                    onClick={loadServerLogs}
                    disabled={isLoadingLogs}
                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg"
                  >
                    {isLoadingLogs ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />}
                    Refresh
                  </button>
                </div>
              </div>

              <div className="flex gap-2 mb-4">
                {['all', 'error', 'warn', 'info'].map(level => (
                  <button
                    key={level}
                    onClick={() => { setLogLevelFilter(level); setTimeout(loadServerLogs, 0) }}
                    className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                      logLevelFilter === level
                        ? level === 'error' ? 'bg-red-600 text-white'
                          : level === 'warn' ? 'bg-yellow-600 text-white'
                          : level === 'info' ? 'bg-blue-600 text-white'
                          : 'bg-gray-600 text-white'
                        : 'bg-gray-700 text-gray-400 hover:text-white'
                    }`}
                  >
                    {level.charAt(0).toUpperCase() + level.slice(1)}
                  </button>
                ))}
                <input
                  type="text"
                  placeholder="Search logs..."
                  value={logSearchTerm}
                  onChange={e => setLogSearchTerm(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && loadServerLogs()}
                  className="flex-1 px-3 py-1.5 bg-gray-700 border border-gray-600 rounded-lg text-sm text-white placeholder-gray-400"
                />
              </div>

              <div className="bg-gray-900 rounded-lg overflow-y-auto max-h-[60vh] font-mono text-xs">
                {serverLogs.length === 0 ? (
                  <p className="p-4 text-gray-500">No logs matching filters</p>
                ) : (
                  serverLogs.map((log: any, idx: number) => (
                    <div key={idx} className={`px-4 py-1.5 border-b border-gray-800/50 flex gap-3 ${
                      log.level === 'error' ? 'bg-red-900/10 text-red-300'
                        : log.level === 'warn' ? 'bg-yellow-900/10 text-yellow-300'
                        : 'text-gray-300'
                    }`}>
                      <span className="text-gray-500 whitespace-nowrap">{new Date(log.timestamp).toLocaleTimeString()}</span>
                      <span className={`w-12 text-center font-bold ${
                        log.level === 'error' ? 'text-red-400' : log.level === 'warn' ? 'text-yellow-400' : 'text-blue-400'
                      }`}>{log.level.toUpperCase()}</span>
                      <span className="break-all">{log.message}</span>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        )}

        {/* ========== USERS TAB ==========
            Displays searchable/filterable user table with management actions */}
        {activeTab === 'users' && (
          <div className="space-y-6">
            <div className="bg-gray-800 rounded-xl p-6">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h2 className="text-xl font-bold">User Management</h2>
                  {totalUserCount > 0 && (
                    <p className="text-sm text-gray-400 mt-1">
                      Showing {detailedUsers.length} of {totalUserCount} users (Page {currentPage + 1}/{totalPages})
                    </p>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => loadDetailedUsers(currentPage)}
                    disabled={isLoadingUsers}
                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg transition-colors"
                  >
                    {isLoadingUsers ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />}
                    {isLoadingUsers ? 'Loading...' : 'Load Users'}
                  </button>
                  <button onClick={handleBulkDeleteInactive} disabled={isRunningBulkDelete} className="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 disabled:opacity-50 rounded-lg transition-colors">
                    {isRunningBulkDelete ? <Loader2 className="w-4 h-4 animate-spin" /> : <UserX className="w-4 h-4" />}
                    {isRunningBulkDelete ? 'Deleting...' : 'Delete Inactive'}
                  </button>
                </div>
              </div>

              <div className="flex items-center gap-4 mb-4">
                <div className="flex-1">
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
                    <input
                      type="text"
                      placeholder="Search by phone number, user ID, or email..."
                      value={userSearchTerm}
                      onChange={(e) => setUserSearchTerm(e.target.value)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                          setCurrentPage(0)
                          loadDetailedUsers(0)
                        }
                      }}
                      className="w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </div>
                <button
                  onClick={() => {
                    setCurrentPage(0)
                    loadDetailedUsers(0)
                  }}
                  disabled={isLoadingUsers}
                  className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors flex items-center gap-2"
                >
                  <Search className="w-4 h-4" />
                  Search
                </button>
                <select
                  value={userFilter}
                  onChange={(e) => {
                    onFilterChange(e.target.value as 'all' | 'active' | 'inactive')
                    loadDetailedUsers(0)
                  }}
                  className="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="all">All Users</option>
                  <option value="active">Active Only</option>
                  <option value="inactive">Inactive Only</option>
                </select>
              </div>

              <div className="bg-gray-800 rounded-xl overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-700">
                      <tr>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-300">User ID</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-300">Phone</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-300">Messages</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-300">Storage</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-300">Devices</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-300">Plan</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-300">Expires</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-300">Assigned By</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-300">Last Active</th>
                        <th className="px-3 py-2 text-left text-xs font-medium text-gray-300">Status</th>
                        <th className="px-3 py-2 text-center text-xs font-medium text-gray-300">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {detailedUsers.map((user) => (
                          <tr key={user.userId} className="border-t border-gray-700 hover:bg-gray-700/50">
                            <td className="px-3 py-2 text-xs font-mono text-blue-400">{user.userId}</td>
                            <td className="px-3 py-2 text-xs font-mono text-green-400">{user.phone || '-'}</td>
                            <td className="px-3 py-2 text-xs">{user.messagesCount.toLocaleString()}</td>
                            <td className="px-3 py-2 text-xs">{user.storageUsedMB}MB</td>
                            <td className="px-3 py-2 text-xs">
                              <span className="px-2 py-1 rounded text-xs font-semibold bg-blue-900/30 text-blue-300">
                                {user.devicesCount}
                              </span>
                            </td>
                            <td className="px-3 py-2 text-xs">
                              <span className={`px-2 py-1 rounded text-xs font-medium ${
                                user.wasPremium && user.plan !== 'free'
                                  ? 'bg-purple-900 text-purple-300'
                                  : 'bg-gray-700 text-gray-300'
                              }`}>
                                {user.plan}
                              </span>
                            </td>
                            <td className="px-3 py-2 text-xs text-gray-300">
                              {user.planExpiresAt ? new Date(user.planExpiresAt).toLocaleDateString() : '-'}
                            </td>
                            <td className="px-3 py-2 text-xs text-gray-300">
                              {user.planAssignedBy || '-'}
                            </td>
                            <td className="px-3 py-2 text-xs text-gray-300">
                              {user.lastActivity ? new Date(user.lastActivity).toLocaleDateString() : 'Never'}
                            </td>
                            <td className="px-3 py-2"><span className={`px-2 py-1 rounded text-xs font-medium ${user.isActive ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`}>{user.isActive ? 'Active' : 'Inactive'}</span></td>
                            <td className="px-3 py-2 text-center">
                              <button onClick={() => handleDeleteUser(user.userId)} disabled={deletingUser === user.userId} className="px-2 py-1 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:bg-gray-600 text-white text-xs font-medium rounded transition-colors">
                                {deletingUser === user.userId ? <Loader2 className="w-3 h-3 animate-spin inline" /> : <UserX className="w-3 h-3 inline" />}
                              </button>
                            </td>
                          </tr>
                        ))}
                    </tbody>
                  </table>
                </div>

                {/* Pagination Controls */}
                {totalPages > 0 && (
                  <div className="flex items-center justify-between px-6 py-4 border-t border-gray-700">
                    <div className="text-sm text-gray-400">
                      Page {currentPage + 1} of {totalPages} ({totalUserCount} total users)
                    </div>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={goToPrevPage}
                        disabled={!hasPrevPage || isLoadingUsers}
                        className="px-3 py-1 bg-gray-700 hover:bg-gray-600 disabled:bg-gray-800 disabled:cursor-not-allowed disabled:opacity-50 text-white text-sm rounded transition-colors"
                      >
                        Previous
                      </button>

                      {/* Page numbers */}
                      <div className="flex items-center gap-1">
                        {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                          let pageNum
                          if (totalPages <= 5) {
                            pageNum = i
                          } else if (currentPage < 3) {
                            pageNum = i
                          } else if (currentPage > totalPages - 4) {
                            pageNum = totalPages - 5 + i
                          } else {
                            pageNum = currentPage - 2 + i
                          }

                          return (
                            <button
                              key={pageNum}
                              onClick={() => goToPage(pageNum)}
                              disabled={isLoadingUsers}
                              className={`px-3 py-1 text-sm rounded transition-colors ${
                                pageNum === currentPage
                                  ? 'bg-blue-600 text-white'
                                  : 'bg-gray-700 hover:bg-gray-600 text-white disabled:opacity-50'
                              }`}
                            >
                              {pageNum + 1}
                            </button>
                          )
                        })}
                      </div>

                      <button
                        onClick={goToNextPage}
                        disabled={!hasNextPage || isLoadingUsers}
                        className="px-3 py-1 bg-gray-700 hover:bg-gray-600 disabled:bg-gray-800 disabled:cursor-not-allowed disabled:opacity-50 text-white text-sm rounded transition-colors"
                      >
                        Next
                      </button>
                    </div>
                  </div>
                )}

                {usersError && (
                  <div className="mx-4 my-3 p-3 bg-red-900/30 border border-red-700 rounded-lg text-red-300 text-sm">
                    Error: {usersError}
                  </div>
                )}
                {detailedUsers.length === 0 && !usersError && !isLoadingUsers && <div className="text-center py-8 text-gray-400">No users loaded. Click "Load Users" to fetch data.</div>}
                {isLoadingUsers && detailedUsers.length === 0 && <div className="text-center py-8 text-gray-400">Loading users...</div>}
              </div>
            </div>
          </div>
        )}

        {/* ========== DATA & CLEANUP TAB ==========
            Main cleanup operations organized into sections:
            - Quick Actions (auto cleanup, smart cleanup, scan orphans)
            - User Account Management (duplicates, orphans, scanner)
            - Message & Media Management (SMS, MMS, plan enforcement)
            - Device & Session Management
            - Activity Monitor (real-time log) */}
        {activeTab === 'data' && (
          <div className="space-y-8">
            {/* Executive Summary Header */}
            <div className="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-700 shadow-2xl">
              <div className="flex items-center justify-between mb-6">
                <div className="flex items-center gap-4">
                  <div className="p-3 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl shadow-lg">
                    <Database className="w-8 h-8 text-white" />
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold text-white mb-1">Data Management Center</h2>
                    <p className="text-slate-300">Professional cleanup and optimization tools</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="text-right">
                    <div className="text-2xl font-bold text-white">{cleanupLog.length}</div>
                    <div className="text-xs text-slate-400 uppercase tracking-wide">Operations Logged</div>
                  </div>
                  <div className="w-px h-12 bg-slate-600"></div>
                  <div className="text-right">
                    <div className="text-2xl font-bold text-green-400">Active</div>
                    <div className="text-xs text-slate-400 uppercase tracking-wide">System Status</div>
                  </div>
                </div>
              </div>

              {/* Quick Action Bar */}
              <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-600">
                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <Zap className="w-5 h-5 text-yellow-400" />
                  Quick Actions
                </h3>
                <div className="flex flex-wrap gap-4">
                  <button
                    onClick={handleAutoCleanup}
                    disabled={isRunningAuto || !userId}
                    className="flex items-center gap-3 px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-xl shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105"
                  >
                    {isRunningAuto ? <Loader2 className="w-5 h-5 animate-spin" /> : <Zap className="w-5 h-5" />}
                    <div className="text-left">
                      <div className="text-sm font-bold">Auto Cleanup</div>
                      <div className="text-xs opacity-90">12 categories â€¢ Full report</div>
                    </div>
                  </button>

                  <button
                    onClick={handleSmartGlobalCleanup}
                    disabled={isRunningSmartCleanup}
                    className="flex items-center gap-3 px-6 py-4 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white font-semibold rounded-xl shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105"
                  >
                    {isRunningSmartCleanup ? <Loader2 className="w-5 h-5 animate-spin" /> : <Activity className="w-5 h-5" />}
                    <div className="text-left">
                      <div className="text-sm font-bold">Smart Cleanup</div>
                      <div className="text-xs opacity-90">Plan-based â€¢ Intelligent</div>
                    </div>
                  </button>

                  <button
                    onClick={handleDetectOrphans}
                    disabled={isDetectingOrphans}
                    className="flex items-center gap-3 px-6 py-4 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-semibold rounded-xl shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105"
                  >
                    {isDetectingOrphans ? <Loader2 className="w-5 h-5 animate-spin" /> : <Search className="w-5 h-5" />}
                    <div className="text-left">
                      <div className="text-sm font-bold">Scan Orphans</div>
                      <div className="text-xs opacity-90">Find wasted data</div>
                    </div>
                  </button>
                </div>
              </div>
            </div>

            {/* User Management Section */}
            <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
              <div className="bg-gradient-to-r from-indigo-500 to-purple-600 p-6">
                <h3 className="text-xl font-bold text-white flex items-center gap-3">
                  <div className="p-2 bg-white/20 rounded-lg">
                    <Users className="w-6 h-6 text-white" />
                  </div>
                  User Account Management
                </h3>
                <p className="text-indigo-100 mt-2">Manage user accounts, duplicates, and orphaned data</p>
              </div>

              <div className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {/* Duplicate Users Card */}
                  <div className="group bg-gradient-to-br from-red-50 to-pink-50 border border-red-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200">
                    <div className="flex items-start justify-between mb-4">
                      <div className="p-3 bg-red-100 rounded-xl group-hover:bg-red-200 transition-colors">
                        <AlertTriangle className="w-6 h-6 text-red-600" />
                      </div>
                      <div className="text-right">
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                          {totalDuplicateAccounts} to Delete
                        </span>
                      </div>
                    </div>

                    <h4 className="font-bold text-gray-900 mb-2">Duplicate Users</h4>
                    <p className="text-sm text-gray-600 mb-4 leading-relaxed">
                      Remove accounts created from device disconnect/reconnect cycles
                      {duplicatesList.length > 0 && (
                        <span className="block mt-1 text-xs text-gray-500">
                          Found on {duplicatesList.length} device{duplicatesList.length !== 1 ? 's' : ''}
                        </span>
                      )}
                    </p>

                    <div className="flex gap-2">
                      <button
                        onClick={handleDetectDuplicates}
                        disabled={isDetectingDuplicates}
                        className="flex-1 px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 disabled:opacity-50 transition-colors"
                      >
                        {isDetectingDuplicates ? 'Scanning...' : 'Detect'}
                      </button>
                      <button
                        onClick={handleDeleteDuplicates}
                        disabled={isDeletingDuplicates || totalDuplicateAccounts === 0}
                        className="px-4 py-2 bg-red-700 text-white text-sm font-medium rounded-lg hover:bg-red-800 disabled:opacity-50 transition-colors"
                      >
                        {isDeletingDuplicates ? '...' : `Delete ${totalDuplicateAccounts}`}
                      </button>
                    </div>
                  </div>

                  {/* Orphaned Accounts Card */}
                  <div className="group bg-gradient-to-br from-orange-50 to-red-50 border border-orange-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200">
                    <div className="flex items-start justify-between mb-4">
                      <div className="p-3 bg-orange-100 rounded-xl group-hover:bg-orange-200 transition-colors">
                        <UserX className="w-6 h-6 text-orange-600" />
                      </div>
                      <div className="text-right">
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                          Critical
                        </span>
                      </div>
                    </div>

                    <h4 className="font-bold text-gray-900 mb-2">Orphaned Accounts</h4>
                    <p className="text-sm text-gray-600 mb-4 leading-relaxed">
                      Remove users without active devices who cannot access their messages
                    </p>

                    <div className="mb-3 p-3 bg-orange-100 rounded-lg">
                      <div className="flex items-center gap-2 text-xs text-orange-800 font-medium">
                        <DollarSign className="w-4 h-4" />
                        ~$0.005/month savings per user
                      </div>
                    </div>

                    <button
                      onClick={handleDeleteNoDeviceUsers}
                      disabled={isDeletingNoDeviceUsers}
                      className="w-full px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 disabled:opacity-50 transition-colors"
                    >
                      {isDeletingNoDeviceUsers ? 'Deleting...' : 'Delete Orphaned Users'}
                    </button>
                  </div>

                  {/* Data Scanner Card */}
                  <div className="group bg-gradient-to-br from-emerald-50 to-teal-50 border border-emerald-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200 md:col-span-2 lg:col-span-1">
                    <div className="flex items-start justify-between mb-4">
                      <div className="p-3 bg-emerald-100 rounded-xl group-hover:bg-emerald-200 transition-colors">
                        <Search className="w-6 h-6 text-emerald-600" />
                      </div>
                      <div className="text-right">
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                          Analysis
                        </span>
                      </div>
                    </div>

                    <h4 className="font-bold text-gray-900 mb-2">Data Integrity Scanner</h4>
                    <p className="text-sm text-gray-600 mb-4 leading-relaxed">
                      Comprehensive scan for orphaned nodes, empty accounts, and data inconsistencies
                    </p>

                    <button
                      onClick={handleDetectOrphans}
                      disabled={isDetectingOrphans}
                      className="w-full px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-lg hover:bg-emerald-700 disabled:opacity-50 transition-colors"
                    >
                      {isDetectingOrphans ? 'Scanning...' : 'Start Deep Scan'}
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* Message Management Section */}
            <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
              <div className="bg-gradient-to-r from-cyan-500 to-blue-600 p-6">
                <h3 className="text-xl font-bold text-white flex items-center gap-3">
                  <div className="p-2 bg-white/20 rounded-lg">
                    <MessageSquare className="w-6 h-6 text-white" />
                  </div>
                  Message & Media Management
                </h3>
                <p className="text-cyan-100 mt-2">Clean up old messages, media files, and enforce plan limits</p>
              </div>

              <div className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {/* SMS Cleanup Card */}
                  <div className="group bg-gradient-to-br from-blue-50 to-cyan-50 border border-blue-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200">
                    <div className="flex items-start justify-between mb-4">
                      <div className="p-3 bg-blue-100 rounded-xl group-hover:bg-blue-200 transition-colors">
                        <Mail className="w-6 h-6 text-blue-600" />
                      </div>
                      <div className="text-right">
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                          SMS Only
                        </span>
                      </div>
                    </div>

                    <h4 className="font-bold text-gray-900 mb-2">SMS Message Cleanup</h4>
                    <p className="text-sm text-gray-600 mb-4 leading-relaxed">
                      Remove SMS messages older than retention periods based on user plans
                    </p>

                    <div className="mb-3 space-y-2">
                      <div className="flex justify-between text-xs">
                        <span className="text-gray-600">Free Tier:</span>
                        <span className="font-medium text-gray-900">30 days</span>
                      </div>
                      <div className="flex justify-between text-xs">
                        <span className="text-gray-600">Paid Plans:</span>
                        <span className="font-medium text-gray-900">90 days</span>
                      </div>
                      <div className="flex justify-between text-xs">
                        <span className="text-gray-600">Storage per message:</span>
                        <span className="font-medium text-gray-900">~500 bytes</span>
                      </div>
                    </div>

                    <button
                      onClick={handleDeleteOldMessages}
                      disabled={isDeletingOldMessages}
                      className="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors"
                    >
                      {isDeletingOldMessages ? 'Cleaning...' : 'Clean Old SMS'}
                    </button>
                  </div>

                  {/* MMS Cleanup Card */}
                  <div className="group bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200">
                    <div className="flex items-start justify-between mb-4">
                      <div className="p-3 bg-orange-100 rounded-xl group-hover:bg-orange-200 transition-colors">
                        <HardDrive className="w-6 h-6 text-orange-600" />
                      </div>
                      <div className="text-right">
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                          High Impact
                        </span>
                      </div>
                    </div>

                    <h4 className="font-bold text-gray-900 mb-2">MMS & Media Cleanup</h4>
                    <p className="text-sm text-gray-600 mb-4 leading-relaxed">
                      Aggressively remove MMS messages and large media attachments
                    </p>

                    <div className="mb-3 space-y-2">
                      <div className="flex justify-between text-xs">
                        <span className="text-gray-600">Free Tier:</span>
                        <span className="font-medium text-gray-900">7 days</span>
                      </div>
                      <div className="flex justify-between text-xs">
                        <span className="text-gray-600">Paid Plans:</span>
                        <span className="font-medium text-gray-900">90 days</span>
                      </div>
                      <div className="flex justify-between text-xs">
                        <span className="text-gray-600">Avg. size per MMS:</span>
                        <span className="font-medium text-gray-900">~2MB</span>
                      </div>
                    </div>

                    <button
                      onClick={handleDeleteOldMms}
                      disabled={isDeletingOldMms}
                      className="w-full px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 disabled:opacity-50 transition-colors"
                    >
                      {isDeletingOldMms ? 'Cleaning...' : 'Clean MMS & Media'}
                    </button>
                  </div>

                  {/* Plan Enforcement Card */}
                  <div className="group bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200">
                    <div className="flex items-start justify-between mb-4">
                      <div className="p-3 bg-green-100 rounded-xl group-hover:bg-green-200 transition-colors">
                        <Shield className="w-6 h-6 text-green-600" />
                      </div>
                      <div className="text-right">
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                          Policy
                        </span>
                      </div>
                    </div>

                    <h4 className="font-bold text-gray-900 mb-2">Free Tier Enforcement</h4>
                    <p className="text-sm text-gray-600 mb-4 leading-relaxed">
                      Remove calls and media from free users, keeping SMS only for compliance
                    </p>

                    <div className="mb-3 p-3 bg-green-100 rounded-lg">
                      <div className="flex items-center gap-2 text-xs text-green-800 font-medium">
                        <TrendingUp className="w-4 h-4" />
                        95% storage reduction per free user
                      </div>
                    </div>

                    <button
                      onClick={handleEnforceSmsFree}
                      disabled={isEnforcingSms}
                      className="w-full px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors"
                    >
                      {isEnforcingSms ? 'Enforcing...' : 'Enforce SMS Only'}
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* Device Management Section */}
            <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
              <div className="bg-gradient-to-r from-slate-600 to-slate-700 p-6">
                <h3 className="text-xl font-bold text-white flex items-center gap-3">
                  <div className="p-2 bg-white/20 rounded-lg">
                    <UserX className="w-6 h-6 text-white" />
                  </div>
                  Device & Session Management
                </h3>
                <p className="text-slate-200 mt-2">Clean up device registrations and session data</p>
              </div>

              <div className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="group bg-gradient-to-br from-slate-50 to-gray-50 border border-slate-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200">
                    <div className="flex items-start justify-between mb-4">
                      <div className="p-3 bg-slate-100 rounded-xl group-hover:bg-slate-200 transition-colors">
                        <UserX className="w-6 h-6 text-slate-600" />
                      </div>
                      <div className="text-right">
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
                          Maintenance
                        </span>
                      </div>
                    </div>

                    <h4 className="font-bold text-gray-900 mb-2">Device Registry Cleanup</h4>
                    <p className="text-sm text-gray-600 mb-4 leading-relaxed">
                      Remove duplicate and inactive device entries from the registry
                    </p>

                    <div className="mb-3 p-3 bg-slate-100 rounded-lg">
                      <div className="flex items-center gap-2 text-xs text-slate-800 font-medium">
                        <RefreshCw className="w-4 h-4" />
                        Cleans devices inactive for 7+ days
                      </div>
                    </div>

                    <button
                      onClick={handleDeviceCleanup}
                      disabled={isRunningDeviceCleanup}
                      className="w-full px-4 py-2 bg-slate-600 text-white text-sm font-medium rounded-lg hover:bg-slate-700 disabled:opacity-50 transition-colors"
                    >
                      {isRunningDeviceCleanup ? 'Cleaning...' : 'Clean Device Registry'}
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* Activity Monitor */}
            <div className="bg-slate-900 rounded-2xl shadow-2xl border border-slate-700 overflow-hidden">
              <div className="bg-gradient-to-r from-slate-800 to-slate-900 p-6 border-b border-slate-700">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-slate-700 rounded-lg">
                      <Activity className="w-5 h-5 text-slate-300" />
                    </div>
                    <div>
                      <h3 className="text-lg font-bold text-white">Cleanup Activity Monitor</h3>
                      <p className="text-slate-400 text-sm">Real-time operation logs and system status</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                      <span className="text-xs text-slate-400 uppercase tracking-wide">Live</span>
                    </div>
                    <button
                      onClick={() => setCleanupLog([])}
                      className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm font-medium rounded-lg transition-colors"
                    >
                      Clear Logs
                    </button>
                  </div>
                </div>
              </div>

              <div className="p-6">
                <div ref={logContainerRef} className="bg-slate-800 rounded-xl p-4 font-mono text-sm max-h-80 overflow-y-auto border border-slate-600">
                  {cleanupLog.length === 0 ? (
                    <div className="text-center py-8">
                      <Activity className="w-12 h-12 text-slate-600 mx-auto mb-3" />
                      <p className="text-slate-500">No cleanup activity yet.</p>
                      <p className="text-slate-600 text-sm">Run operations above to see live activity logs.</p>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {cleanupLog.slice(-30).map((log: string, index: number) => {
                        const isError = log.toLowerCase().includes('error') || log.toLowerCase().includes('failed')
                        const isSuccess = log.toLowerCase().includes('completed') || log.toLowerCase().includes('success')
                        const isWarning = log.toLowerCase().includes('warning') || log.toLowerCase().includes('orphan')

                        return (
                          <div
                            key={index}
                            className={`p-3 rounded-lg border-l-4 ${
                              isError ? 'bg-red-900/20 border-red-500 text-red-300' :
                              isSuccess ? 'bg-green-900/20 border-green-500 text-green-300' :
                              isWarning ? 'bg-yellow-900/20 border-yellow-500 text-yellow-300' :
                              'bg-slate-700/50 border-slate-500 text-slate-300'
                            }`}
                          >
                            <div className="flex items-start gap-3">
                              <div className={`w-2 h-2 rounded-full mt-2 ${
                                isError ? 'bg-red-400' :
                                isSuccess ? 'bg-green-400' :
                                isWarning ? 'bg-yellow-400' :
                                'bg-slate-400'
                              }`}></div>
                              <div className="flex-1 font-medium text-xs leading-relaxed">{log}</div>
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ========== COSTS & ANALYTICS TAB ==========
            Displays cost optimization recommendations with one-click implementation */}
        {activeTab === 'costs' && (
          <div className="space-y-6">
            {/* Header */}
            <div className="bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl p-6 text-white">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold mb-2">VPS Cost & Analytics</h2>
                  <p className="text-purple-100">Server costs, bandwidth, retention, and feature usage</p>
                </div>
                <button
                  onClick={loadCostMonitoring}
                  disabled={isLoadingCosts}
                  className="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors disabled:opacity-50"
                >
                  {isLoadingCosts ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />}
                  Refresh
                </button>
              </div>
            </div>

            {/* Cost Summary Cards */}
            {costEstimate && (
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-gray-800 rounded-xl p-6 border-l-4 border-blue-500">
                  <div className="flex items-center gap-3 mb-3">
                    <Cloud className="w-6 h-6 text-blue-400" />
                    <span className="text-sm text-gray-400">R2 Storage</span>
                  </div>
                  <p className="text-2xl font-bold">${costEstimate.storage?.estimatedCost?.toFixed(4) || '0.00'}</p>
                  <p className="text-xs text-gray-400 mt-1">{((costEstimate.storage?.bytes || 0) / (1024 * 1024 * 1024)).toFixed(2)} GB stored</p>
                </div>

                <div className="bg-gray-800 rounded-xl p-6 border-l-4 border-green-500">
                  <div className="flex items-center gap-3 mb-3">
                    <Activity className="w-6 h-6 text-green-400" />
                    <span className="text-sm text-gray-400">Bandwidth (this month)</span>
                  </div>
                  <p className="text-2xl font-bold">${costEstimate.bandwidth?.estimatedCost?.toFixed(4) || '0.00'}</p>
                  <p className="text-xs text-gray-400 mt-1">{((costEstimate.bandwidth?.bytes || 0) / (1024 * 1024 * 1024)).toFixed(2)} GB egress</p>
                </div>

                <div className="bg-gray-800 rounded-xl p-6 border-l-4 border-purple-500">
                  <div className="flex items-center gap-3 mb-3">
                    <Database className="w-6 h-6 text-purple-400" />
                    <span className="text-sm text-gray-400">Database Size</span>
                  </div>
                  <p className="text-2xl font-bold">{costEstimate.database?.size || 'unknown'}</p>
                  <p className="text-xs text-gray-400 mt-1">PostgreSQL on VPS</p>
                </div>
              </div>
            )}

            {/* Total Cost Estimate */}
            {costEstimate && (
              <div className="bg-gray-800 rounded-xl p-6">
                <h3 className="text-lg font-semibold mb-4">Monthly Cost Estimate</h3>
                <div className="space-y-3">
                  {[
                    { label: 'R2 Storage ($0.015/GB)', cost: costEstimate.storage?.estimatedCost || 0, color: 'bg-blue-500' },
                    { label: 'R2 Bandwidth ($0.045/GB after 10GB free)', cost: costEstimate.bandwidth?.estimatedCost || 0, color: 'bg-green-500' },
                  ].map((item) => {
                    const totalCost = (costEstimate.storage?.estimatedCost || 0) + (costEstimate.bandwidth?.estimatedCost || 0)
                    const pct = totalCost > 0 ? (item.cost / totalCost) * 100 : 0
                    return (
                      <div key={item.label}>
                        <div className="flex justify-between text-sm mb-1">
                          <span className="text-gray-400">{item.label}</span>
                          <span className="font-medium">${item.cost.toFixed(4)}</span>
                        </div>
                        <div className="w-full bg-gray-700 rounded-full h-2">
                          <div className={`${item.color} h-2 rounded-full transition-all`} style={{ width: `${Math.max(pct, 1)}%` }} />
                        </div>
                      </div>
                    )
                  })}
                  <div className="border-t border-gray-700 pt-3 flex justify-between">
                    <span className="font-medium">Total R2 Costs</span>
                    <span className="text-xl font-bold text-green-400">
                      ${((costEstimate.storage?.estimatedCost || 0) + (costEstimate.bandwidth?.estimatedCost || 0)).toFixed(4)}
                    </span>
                  </div>
                  <p className="text-xs text-gray-500">VPS server + database costs are fixed and not included above.</p>
                </div>
              </div>
            )}

            {/* Bandwidth Details */}
            {bandwidth && (
              <div className="bg-gray-800 rounded-xl p-6">
                <h3 className="text-lg font-semibold mb-4">Bandwidth Analytics</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div className="bg-gray-700/50 rounded-lg p-4">
                    <p className="text-sm text-gray-400 mb-1">Total This Month</p>
                    <p className="text-2xl font-bold">{((bandwidth.totalBytesThisMonth || 0) / (1024 * 1024 * 1024)).toFixed(2)} GB</p>
                  </div>
                  <div className="bg-gray-700/50 rounded-lg p-4">
                    <p className="text-sm text-gray-400 mb-1">Top Consumers</p>
                    <p className="text-2xl font-bold">{(bandwidth.topUsers || []).length} users</p>
                  </div>
                </div>
                {bandwidth.topUsers && bandwidth.topUsers.length > 0 && (
                  <div>
                    <p className="text-sm text-gray-400 mb-2">Top Bandwidth Users</p>
                    <div className="space-y-2">
                      {bandwidth.topUsers.slice(0, 10).map((u: any, i: number) => (
                        <div key={u.userId} className="flex items-center justify-between bg-gray-700/30 rounded-lg px-4 py-2">
                          <span className="text-sm font-mono">{i + 1}. {u.userId.slice(0, 16)}...</span>
                          <span className="text-sm font-medium">{(u.bytes / (1024 * 1024)).toFixed(1)} MB</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                {bandwidth.dailyTrend && bandwidth.dailyTrend.length > 0 && (
                  <div className="mt-4">
                    <p className="text-sm text-gray-400 mb-2">Daily Trend (last 30 days)</p>
                    <div className="flex items-end gap-1 h-24">
                      {(() => {
                        const maxBytes = Math.max(...bandwidth.dailyTrend.map((d: any) => d.bytes), 1)
                        return bandwidth.dailyTrend.map((d: any, i: number) => (
                          <div key={i} className="flex-1 group relative">
                            <div
                              className="bg-blue-500 hover:bg-blue-400 rounded-t transition-colors w-full"
                              style={{ height: `${Math.max((d.bytes / maxBytes) * 96, 2)}px` }}
                              title={`${new Date(d.date).toLocaleDateString()}: ${(d.bytes / (1024 * 1024)).toFixed(1)} MB`}
                            />
                          </div>
                        ))
                      })()}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* User Retention */}
            {analyticsRetention && (
              <div className="bg-gray-800 rounded-xl p-6">
                <h3 className="text-lg font-semibold mb-4">User Retention</h3>
                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                  {[
                    { label: 'Active 1d', value: analyticsRetention.active1d, color: 'text-green-400' },
                    { label: 'Active 7d', value: analyticsRetention.active7d, color: 'text-green-400' },
                    { label: 'Active 30d', value: analyticsRetention.active30d, color: 'text-blue-400' },
                    { label: 'Active 90d', value: analyticsRetention.active90d, color: 'text-yellow-400' },
                    { label: 'Churn Rate', value: `${(analyticsRetention.churnRate * 100).toFixed(1)}%`, color: analyticsRetention.churnRate > 0.5 ? 'text-red-400' : 'text-green-400' },
                  ].map((item) => (
                    <div key={item.label} className="bg-gray-700/50 rounded-lg p-4 text-center">
                      <p className={`text-2xl font-bold ${item.color}`}>{item.value}</p>
                      <p className="text-xs text-gray-400 mt-1">{item.label}</p>
                    </div>
                  ))}
                </div>
                <p className="text-xs text-gray-500 mt-3">Total users: {analyticsRetention.totalUsers}</p>
              </div>
            )}

            {/* Feature Usage */}
            {analyticsFeatures.length > 0 && (
              <div className="bg-gray-800 rounded-xl p-6">
                <h3 className="text-lg font-semibold mb-4">Feature Usage</h3>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b border-gray-700">
                        <th className="text-left py-2 px-3 text-sm text-gray-400">Feature</th>
                        <th className="text-right py-2 px-3 text-sm text-gray-400">Users</th>
                        <th className="text-right py-2 px-3 text-sm text-gray-400">Records</th>
                      </tr>
                    </thead>
                    <tbody>
                      {analyticsFeatures.map((f: any) => (
                        <tr key={f.name} className="border-b border-gray-700/50">
                          <td className="py-2 px-3 text-sm">{f.name}</td>
                          <td className="py-2 px-3 text-sm text-right font-medium">{f.userCount.toLocaleString()}</td>
                          <td className="py-2 px-3 text-sm text-right text-gray-400">{f.totalRecords.toLocaleString()}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Dashboard Trends */}
            {analyticsDashboard && (
              <div className="bg-gray-800 rounded-xl p-6">
                <h3 className="text-lg font-semibold mb-4">30-Day Trends</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  {[
                    { label: 'Daily Active Users', data: analyticsDashboard.dau, color: 'bg-green-500' },
                    { label: 'New Users', data: analyticsDashboard.newUsers, color: 'bg-blue-500' },
                    { label: 'Message Volume', data: analyticsDashboard.messageVolume, color: 'bg-purple-500' },
                  ].map((chart) => (
                    <div key={chart.label}>
                      <p className="text-sm text-gray-400 mb-2">{chart.label}</p>
                      {chart.data && chart.data.length > 0 ? (
                        <div className="flex items-end gap-0.5 h-16">
                          {(() => {
                            const maxVal = Math.max(...chart.data.map((d: any) => d.count), 1)
                            return chart.data.map((d: any, i: number) => (
                              <div key={i} className="flex-1 group relative">
                                <div
                                  className={`${chart.color} hover:opacity-80 rounded-t transition-colors w-full`}
                                  style={{ height: `${Math.max((d.count / maxVal) * 64, 1)}px` }}
                                  title={`${new Date(d.date).toLocaleDateString()}: ${d.count}`}
                                />
                              </div>
                            ))
                          })()}
                        </div>
                      ) : (
                        <p className="text-xs text-gray-500">No data</p>
                      )}
                      <p className="text-xs text-gray-500 mt-1">
                        Total: {(chart.data || []).reduce((sum: number, d: any) => sum + d.count, 0).toLocaleString()}
                      </p>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Load button if no data */}
            {!costEstimate && !isLoadingCosts && (
              <div className="bg-gray-800 rounded-xl p-12 text-center">
                <DollarSign className="w-16 h-16 text-gray-600 mx-auto mb-4" />
                <h3 className="text-xl font-semibold mb-2">VPS Cost & Analytics</h3>
                <p className="text-gray-400 mb-6">Load cost estimates, bandwidth usage, retention metrics, and feature analytics</p>
                <button
                  onClick={loadCostMonitoring}
                  className="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
                >
                  Load Analytics Data
                </button>
              </div>
            )}
          </div>
        )}

        {/* ========== R2 STORAGE TAB ==========
            Cloudflare R2 storage management with:
            - Analytics (file counts, sizes, costs)
            - Category breakdown (files, MMS, photos)
            - Cleanup operations by age and type
            - Top users by storage usage */}
        {activeTab === 'storage' && (
          <div className="space-y-6">
            {/* R2 Storage Header */}
            <div className="bg-gradient-to-br from-sky-600 to-blue-700 rounded-2xl p-8 border border-sky-500 shadow-2xl">
              <div className="flex items-center justify-between mb-6">
                <div className="flex items-center gap-4">
                  <div className="p-3 bg-white/20 rounded-xl shadow-lg">
                    <Cloud className="w-8 h-8 text-white" />
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold text-white mb-1">R2 Storage Management</h2>
                    <p className="text-sky-100">Cloudflare R2 file storage analytics and cleanup</p>
                  </div>
                </div>
                <button
                  onClick={loadR2Analytics}
                  disabled={isLoadingR2}
                  className="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-colors disabled:opacity-50"
                >
                  {isLoadingR2 ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />}
                  Refresh Analytics
                </button>
              </div>

              {/* Analytics Summary */}
              {r2Analytics && (
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-white/10 rounded-xl p-4">
                    <div className="flex items-center gap-2 mb-2">
                      <File className="w-5 h-5 text-sky-200" />
                      <span className="text-sm text-sky-200">Total Files</span>
                    </div>
                    <p className="text-2xl font-bold text-white">{r2Analytics.totalFiles.toLocaleString()}</p>
                  </div>
                  <div className="bg-white/10 rounded-xl p-4">
                    <div className="flex items-center gap-2 mb-2">
                      <HardDrive className="w-5 h-5 text-sky-200" />
                      <span className="text-sm text-sky-200">Total Size</span>
                    </div>
                    <p className="text-2xl font-bold text-white">{(r2Analytics.totalSize / (1024 * 1024)).toFixed(2)} MB</p>
                  </div>
                  <div className="bg-white/10 rounded-xl p-4">
                    <div className="flex items-center gap-2 mb-2">
                      <DollarSign className="w-5 h-5 text-sky-200" />
                      <span className="text-sm text-sky-200">Est. Monthly Cost</span>
                    </div>
                    <p className="text-2xl font-bold text-white">${r2Analytics.estimatedCost.toFixed(4)}</p>
                  </div>
                  <div className="bg-white/10 rounded-xl p-4">
                    <div className="flex items-center gap-2 mb-2">
                      <TrendingUp className="w-5 h-5 text-green-300" />
                      <span className="text-sm text-sky-200">Free Egress</span>
                    </div>
                    <p className="text-2xl font-bold text-green-300">Unlimited</p>
                  </div>
                </div>
              )}
            </div>

            {/* File Type Breakdown */}
            {r2Analytics && (
              <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                <div className="bg-gradient-to-r from-gray-700 to-gray-800 p-6">
                  <h3 className="text-xl font-bold text-white flex items-center gap-3">
                    <FileImage className="w-6 h-6" />
                    Storage by Category
                  </h3>
                </div>
                <div className="p-6">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-gradient-to-br from-blue-50 to-cyan-50 border border-blue-200 rounded-xl p-6">
                      <div className="flex items-center gap-3 mb-4">
                        <div className="p-2 bg-blue-100 rounded-lg">
                          <File className="w-5 h-5 text-blue-600" />
                        </div>
                        <span className="font-semibold text-gray-900">File Transfers</span>
                      </div>
                      <p className="text-2xl font-bold text-blue-600">{r2Analytics.fileCounts.files.toLocaleString()}</p>
                      <p className="text-sm text-gray-600">{(r2Analytics.sizeCounts.files / (1024 * 1024)).toFixed(2)} MB</p>
                    </div>
                    <div className="bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200 rounded-xl p-6">
                      <div className="flex items-center gap-3 mb-4">
                        <div className="p-2 bg-orange-100 rounded-lg">
                          <MessageSquare className="w-5 h-5 text-orange-600" />
                        </div>
                        <span className="font-semibold text-gray-900">MMS Attachments</span>
                      </div>
                      <p className="text-2xl font-bold text-orange-600">{r2Analytics.fileCounts.mms.toLocaleString()}</p>
                      <p className="text-sm text-gray-600">{(r2Analytics.sizeCounts.mms / (1024 * 1024)).toFixed(2)} MB</p>
                    </div>
                    <div className="bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-200 rounded-xl p-6">
                      <div className="flex items-center gap-3 mb-4">
                        <div className="p-2 bg-purple-100 rounded-lg">
                          <FileImage className="w-5 h-5 text-purple-600" />
                        </div>
                        <span className="font-semibold text-gray-900">Photo Sync</span>
                      </div>
                      <p className="text-2xl font-bold text-purple-600">{r2Analytics.fileCounts.photos.toLocaleString()}</p>
                      <p className="text-sm text-gray-600">{(r2Analytics.sizeCounts.photos / (1024 * 1024)).toFixed(2)} MB</p>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Cleanup Operations */}
            <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
              <div className="bg-gradient-to-r from-red-500 to-orange-500 p-6">
                <h3 className="text-xl font-bold text-white flex items-center gap-3">
                  <Trash2 className="w-6 h-6" />
                  Cleanup Operations
                </h3>
                <p className="text-red-100 mt-1">Remove old files to reduce storage costs</p>
              </div>
              <div className="p-6">
                <div className="flex flex-wrap items-end gap-4 mb-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Delete files older than</label>
                    <div className="flex items-center gap-2">
                      <input
                        type="number"
                        value={r2CleanupDays}
                        onChange={(e) => setR2CleanupDays(e.target.value)}
                        className="w-24 px-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500"
                        min="1"
                      />
                      <span className="text-gray-600">days</span>
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">File type</label>
                    <select
                      value={r2FileTypeFilter}
                      onChange={(e) => setR2FileTypeFilter(e.target.value as any)}
                      className="px-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500"
                    >
                      <option value="all">All Types</option>
                      <option value="files">File Transfers</option>
                      <option value="mms">MMS Attachments</option>
                      <option value="photos">Photo Sync</option>
                    </select>
                  </div>
                  <button
                    onClick={handleCleanupR2Files}
                    disabled={isCleaningR2}
                    className="flex items-center gap-2 px-6 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 disabled:opacity-50 transition-colors"
                  >
                    {isCleaningR2 ? <Loader2 className="w-4 h-4 animate-spin" /> : <Trash2 className="w-4 h-4" />}
                    {isCleaningR2 ? 'Cleaning...' : 'Clean Old Files'}
                  </button>
                </div>

                {/* Quick cleanup buttons */}
                <div className="flex flex-wrap gap-3">
                  <button
                    onClick={() => { setR2CleanupDays('90'); setTimeout(handleCleanupR2Files, 100) }}
                    disabled={isCleaningR2}
                    className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50 transition-colors text-sm"
                  >
                    Clean 90+ days
                  </button>
                  <button
                    onClick={() => { setR2CleanupDays('30'); setTimeout(handleCleanupR2Files, 100) }}
                    disabled={isCleaningR2}
                    className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50 transition-colors text-sm"
                  >
                    Clean 30+ days
                  </button>
                  <button
                    onClick={() => { setR2CleanupDays('7'); setTimeout(handleCleanupR2Files, 100) }}
                    disabled={isCleaningR2}
                    className="px-4 py-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 disabled:opacity-50 transition-colors text-sm"
                  >
                    Clean 7+ days (aggressive)
                  </button>
                </div>
              </div>
            </div>

            {/* Orphaned Files Cleanup */}
            <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
              <div className="bg-gradient-to-r from-orange-500 to-red-600 p-6">
                <h3 className="text-xl font-bold text-white">Orphaned Files Detection</h3>
                <p className="text-orange-100 mt-1">Find and delete R2 files from deleted users</p>
              </div>

              <div className="p-6">
                <div className="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                  <p className="text-sm text-gray-700">
                    Orphaned files are R2 storage files belonging to users who have been deleted from the database.
                    These files waste storage and increase costs. Use this tool to detect and clean them up.
                  </p>
                </div>

                {orphanedFileCount > 0 && (
                  <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                    <div className="flex items-center gap-2 text-red-800 font-medium mb-2">
                      <AlertCircle className="w-5 h-5" />
                      Found {orphanedFileCount} orphaned files
                    </div>
                    <p className="text-sm text-red-700">
                      Size: {(orphanedFileSize / (1024 * 1024)).toFixed(2)} MB wasted
                    </p>
                  </div>
                )}

                <div className="flex gap-3">
                  <button
                    onClick={() => handleCleanupOrphanedR2(true)}
                    disabled={isCleaningOrphaned}
                    className="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors"
                  >
                    {isCleaningOrphaned ? <Loader2 className="w-5 h-5 animate-spin" /> : <Search className="w-5 h-5" />}
                    {isCleaningOrphaned ? 'Scanning...' : 'Scan for Orphaned Files'}
                  </button>

                  {orphanedFileCount > 0 && (
                    <button
                      onClick={() => handleCleanupOrphanedR2(false)}
                      disabled={isCleaningOrphaned}
                      className="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 disabled:opacity-50 transition-colors"
                    >
                      {isCleaningOrphaned ? <Loader2 className="w-5 h-5 animate-spin" /> : <Trash2 className="w-5 h-5" />}
                      Delete {orphanedFileCount} Orphaned Files
                    </button>
                  )}
                </div>
              </div>
            </div>

            {/* Top Files Lists */}
            {r2Analytics && (r2Analytics.largestFiles.length > 0 || r2Analytics.oldestFiles.length > 0) && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Largest Files */}
                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                  <div className="bg-gradient-to-r from-amber-500 to-orange-500 p-4">
                    <h3 className="text-lg font-bold text-white flex items-center gap-2">
                      <HardDrive className="w-5 h-5" />
                      Largest Files
                    </h3>
                  </div>
                  <div className="p-4">
                    {r2Analytics.largestFiles.length === 0 ? (
                      <p className="text-gray-500 text-center py-4">No files found</p>
                    ) : (
                      <div className="space-y-2">
                        {r2Analytics.largestFiles.slice(0, 10).map((file: any, idx: number) => (
                          <div key={file.key} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div className="flex-1 min-w-0">
                              <p className="text-sm font-medium text-gray-900 truncate">{file.key.split('/').pop()}</p>
                              <p className="text-xs text-gray-500">{(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                            </div>
                            <button
                              onClick={() => handleDeleteR2File(file.key)}
                              disabled={deletingR2File === file.key}
                              className="ml-2 p-2 text-red-600 hover:bg-red-100 rounded-lg disabled:opacity-50 transition-colors"
                            >
                              {deletingR2File === file.key ? <Loader2 className="w-4 h-4 animate-spin" /> : <Trash2 className="w-4 h-4" />}
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>

                {/* Oldest Files */}
                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                  <div className="bg-gradient-to-r from-slate-500 to-gray-600 p-4">
                    <h3 className="text-lg font-bold text-white flex items-center gap-2">
                      <Calendar className="w-5 h-5" />
                      Oldest Files
                    </h3>
                  </div>
                  <div className="p-4">
                    {r2Analytics.oldestFiles.length === 0 ? (
                      <p className="text-gray-500 text-center py-4">No files found</p>
                    ) : (
                      <div className="space-y-2">
                        {r2Analytics.oldestFiles.slice(0, 10).map((file: any, idx: number) => (
                          <div key={file.key} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div className="flex-1 min-w-0">
                              <p className="text-sm font-medium text-gray-900 truncate">{file.key.split('/').pop()}</p>
                              <p className="text-xs text-gray-500">{new Date(file.uploadedAt).toLocaleDateString()}</p>
                            </div>
                            <button
                              onClick={() => handleDeleteR2File(file.key)}
                              disabled={deletingR2File === file.key}
                              className="ml-2 p-2 text-red-600 hover:bg-red-100 rounded-lg disabled:opacity-50 transition-colors"
                            >
                              {deletingR2File === file.key ? <Loader2 className="w-4 h-4 animate-spin" /> : <Trash2 className="w-4 h-4" />}
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Top Users by Storage */}
            {r2Analytics && r2Analytics.userStorage && r2Analytics.userStorage.length > 0 && (
              <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                <div className="bg-gradient-to-r from-indigo-500 to-purple-600 p-4">
                  <div className="flex items-center justify-between">
                    <h3 className="text-lg font-bold text-white flex items-center gap-2">
                      <Users className="w-5 h-5" />
                      Top Users by Storage
                    </h3>
                    <span className="text-sm text-indigo-100">
                      {r2Analytics.totalUsersWithStorage} users with storage
                    </span>
                  </div>
                </div>
                <div className="p-4">
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b border-gray-200">
                          <th className="text-left py-2 px-3 text-sm font-semibold text-gray-600">#</th>
                          <th className="text-left py-2 px-3 text-sm font-semibold text-gray-600">User ID</th>
                          <th className="text-right py-2 px-3 text-sm font-semibold text-gray-600">Storage</th>
                          <th className="text-right py-2 px-3 text-sm font-semibold text-gray-600">Last Updated</th>
                          <th className="text-center py-2 px-3 text-sm font-semibold text-gray-600">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {r2Analytics.userStorage.map((user: any, idx: number) => (
                          <tr key={user.userId} className="border-b border-gray-100 hover:bg-gray-50">
                            <td className="py-2 px-3 text-sm text-gray-500">{idx + 1}</td>
                            <td className="py-2 px-3">
                              <code className="text-sm bg-gray-100 px-2 py-1 rounded font-mono">
                                {user.userId.slice(0, 12)}...
                              </code>
                            </td>
                            <td className="py-2 px-3 text-right">
                              <span className={`text-sm font-medium ${
                                user.storageBytes > 100 * 1024 * 1024 ? 'text-red-600' :
                                user.storageBytes > 50 * 1024 * 1024 ? 'text-orange-600' :
                                'text-gray-900'
                              }`}>
                                {user.storageBytes > 1024 * 1024
                                  ? `${(user.storageBytes / (1024 * 1024)).toFixed(2)} MB`
                                  : `${(user.storageBytes / 1024).toFixed(1)} KB`}
                              </span>
                            </td>
                            <td className="py-2 px-3 text-right text-sm text-gray-500">
                              {user.lastUpdatedAt ? new Date(user.lastUpdatedAt).toLocaleDateString() : '-'}
                            </td>
                            <td className="py-2 px-3 text-center">
                              <button
                                onClick={() => handleRecalculateStorage(user.userId)}
                                disabled={recalculatingUser === user.userId}
                                className="px-2 py-1 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 mx-auto"
                                title="Recalculate storage from actual R2 files"
                              >
                                {recalculatingUser === user.userId ? (
                                  <Loader2 className="w-3 h-3 animate-spin" />
                                ) : (
                                  <RefreshCw className="w-3 h-3" />
                                )}
                                Recalc
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}

            {/* Activity Log */}
            <div className="bg-slate-900 rounded-2xl shadow-2xl border border-slate-700 overflow-hidden">
              <div className="bg-gradient-to-r from-slate-800 to-slate-900 p-4 border-b border-slate-700">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Activity className="w-5 h-5 text-slate-300" />
                    <h3 className="text-lg font-bold text-white">R2 Activity Log</h3>
                  </div>
                  <button
                    onClick={() => setCleanupLog([])}
                    className="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm rounded-lg transition-colors"
                  >
                    Clear
                  </button>
                </div>
              </div>
              <div className="p-4">
                <div ref={logContainerRef} className="bg-slate-800 rounded-xl p-4 font-mono text-sm max-h-48 overflow-y-auto border border-slate-600">
                  {cleanupLog.length === 0 ? (
                    <p className="text-slate-500 text-center py-4">No R2 activity yet. Click "Refresh Analytics" to get started.</p>
                  ) : (
                    <div className="space-y-1">
                      {cleanupLog.slice(-20).map((log, idx) => (
                        <div key={idx} className="text-slate-300 text-xs">{log}</div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'crashes' && (
          <div className="space-y-6">
            {/* Crash Statistics */}
            {crashStats && (
              <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div className="bg-gradient-to-r from-red-600 to-red-700 rounded-lg p-4">
                  <p className="text-sm text-red-100">Total Crashes</p>
                  <p className="text-2xl font-bold text-white">{crashStats.totalCrashes}</p>
                </div>
                <div className="bg-gradient-to-r from-orange-600 to-orange-700 rounded-lg p-4">
                  <p className="text-sm text-orange-100">Unresolved</p>
                  <p className="text-2xl font-bold text-white">{crashStats.unresolvedCrashes}</p>
                </div>
                <div className="bg-gradient-to-r from-purple-600 to-purple-700 rounded-lg p-4">
                  <p className="text-sm text-purple-100">Fatal</p>
                  <p className="text-2xl font-bold text-white">{crashStats.fatalCrashes}</p>
                </div>
                <div className="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg p-4">
                  <p className="text-sm text-blue-100">Non-Fatal</p>
                  <p className="text-2xl font-bold text-white">{crashStats.nonFatalCrashes}</p>
                </div>
                <div className="bg-gradient-to-r from-green-600 to-green-700 rounded-lg p-4">
                  <p className="text-sm text-green-100">Affected Users</p>
                  <p className="text-2xl font-bold text-white">{crashStats.uniqueUsers}</p>
                </div>
                <div className="bg-gradient-to-r from-gray-600 to-gray-700 rounded-lg p-4">
                  <p className="text-sm text-gray-100">Anonymous</p>
                  <p className="text-2xl font-bold text-white">{crashStats.anonymousCrashes}</p>
                </div>
              </div>
            )}

            {/* Top Exceptions */}
            {crashStats && crashStats.topExceptions.length > 0 && (
              <div className="bg-gray-800 rounded-lg p-6">
                <h3 className="text-lg font-semibold text-white mb-4">Top Exception Types</h3>
                <div className="space-y-2">
                  {crashStats.topExceptions.map((exc, i) => (
                    <div key={i} className="flex items-center justify-between text-sm">
                      <span className="text-gray-300">{exc.type}</span>
                      <span className="text-gray-400">{exc.count} crashes</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Filters and Search */}
            <div className="bg-gray-800 rounded-lg p-6">
              <div className="flex flex-wrap gap-4 items-center">
                <div className="flex-1 min-w-[300px]">
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                    <input
                      type="text"
                      placeholder="Search crashes..."
                      value={crashSearchTerm}
                      onChange={(e) => setCrashSearchTerm(e.target.value)}
                      className="w-full bg-gray-700 text-white pl-10 pr-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </div>
                <select
                  value={crashFilter}
                  onChange={(e) => setCrashFilter(e.target.value as any)}
                  className="bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="all">All Crashes</option>
                  <option value="unresolved">Unresolved</option>
                  <option value="fatal">Fatal Only</option>
                  <option value="non-fatal">Non-Fatal Only</option>
                </select>
                <button
                  onClick={loadCrashReports}
                  disabled={isLoadingCrashes}
                  className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50"
                >
                  <RefreshCw className={`w-4 h-4 ${isLoadingCrashes ? 'animate-spin' : ''}`} />
                  Refresh
                </button>
              </div>
            </div>

            {/* Crash List */}
            <div className="bg-gray-800 rounded-lg overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-700">
                    <tr>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-300">Time</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-300">Type</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-300">Exception</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-300">Message</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-300">Device</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-300">Version</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-300">Status</th>
                      <th className="px-4 py-3 text-right text-sm font-medium text-gray-300">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-700">
                    {crashReports
                      .filter(crash => {
                        if (crashFilter === 'unresolved' && crash.resolved) return false
                        if (crashFilter === 'fatal' && !crash.isFatal) return false
                        if (crashFilter === 'non-fatal' && crash.isFatal) return false

                        if (crashSearchTerm) {
                          const search = crashSearchTerm.toLowerCase()
                          return (
                            crash.exceptionType.toLowerCase().includes(search) ||
                            crash.exceptionMessage.toLowerCase().includes(search) ||
                            crash.context.toLowerCase().includes(search) ||
                            crash.deviceModel.toLowerCase().includes(search)
                          )
                        }
                        return true
                      })
                      .map((crash) => (
                        <tr
                          key={crash.id}
                          className="hover:bg-gray-700 cursor-pointer"
                          onClick={() => setSelectedCrash(crash)}
                        >
                          <td className="px-4 py-3 text-sm text-gray-300">
                            {new Date(crash.timestamp).toLocaleString()}
                          </td>
                          <td className="px-4 py-3 text-sm">
                            {crash.isFatal ? (
                              <span className="inline-flex items-center px-2 py-1 rounded-full text-xs bg-red-900 text-red-200">
                                Fatal
                              </span>
                            ) : (
                              <span className="inline-flex items-center px-2 py-1 rounded-full text-xs bg-orange-900 text-orange-200">
                                Non-Fatal
                              </span>
                            )}
                          </td>
                          <td className="px-4 py-3 text-sm text-gray-300 font-mono">
                            {crash.exceptionType}
                          </td>
                          <td className="px-4 py-3 text-sm text-gray-400 max-w-xs truncate">
                            {crash.exceptionMessage}
                          </td>
                          <td className="px-4 py-3 text-sm text-gray-400">
                            {crash.deviceManufacturer} {crash.deviceModel}
                          </td>
                          <td className="px-4 py-3 text-sm text-gray-400">
                            {crash.appVersion}
                          </td>
                          <td className="px-4 py-3 text-sm">
                            {crash.resolved ? (
                              <span className="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-900 text-green-200">
                                Resolved
                              </span>
                            ) : (
                              <span className="inline-flex items-center px-2 py-1 rounded-full text-xs bg-yellow-900 text-yellow-200">
                                Unresolved
                              </span>
                            )}
                          </td>
                          <td className="px-4 py-3 text-sm text-right">
                            <div className="flex items-center justify-end gap-2">
                              {!crash.resolved && (
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation()
                                    handleResolveCrash(crash)
                                  }}
                                  disabled={resolvingCrash === crash.id}
                                  className="text-green-400 hover:text-green-300 disabled:opacity-50"
                                  title="Mark as resolved"
                                >
                                  {resolvingCrash === crash.id ? (
                                    <Loader2 className="w-4 h-4 animate-spin" />
                                  ) : (
                                    <Shield className="w-4 h-4" />
                                  )}
                                </button>
                              )}
                              <button
                                onClick={(e) => {
                                  e.stopPropagation()
                                  handleDeleteCrash(crash)
                                }}
                                disabled={deletingCrash === crash.id}
                                className="text-red-400 hover:text-red-300 disabled:opacity-50"
                                title="Delete crash"
                              >
                                {deletingCrash === crash.id ? (
                                  <Loader2 className="w-4 h-4 animate-spin" />
                                ) : (
                                  <Trash2 className="w-4 h-4" />
                                )}
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                  </tbody>
                </table>
              </div>

              {crashReports.length === 0 && !isLoadingCrashes && (
                <div className="text-center py-12 text-gray-400">
                  No crash reports found
                </div>
              )}

              {isLoadingCrashes && (
                <div className="text-center py-12">
                  <Loader2 className="w-8 h-8 animate-spin text-blue-500 mx-auto" />
                  <p className="text-gray-400 mt-2">Loading crash reports...</p>
                </div>
              )}
            </div>

            {/* Crash Detail Modal */}
            {selectedCrash && (
              <div
                className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
                onClick={() => setSelectedCrash(null)}
              >
                <div
                  className="bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto"
                  onClick={(e) => e.stopPropagation()}
                >
                  <div className="sticky top-0 bg-gray-800 border-b border-gray-700 p-6 flex items-start justify-between">
                    <div>
                      <h3 className="text-xl font-bold text-white mb-2">Crash Details</h3>
                      <div className="flex items-center gap-2">
                        {selectedCrash.isFatal ? (
                          <span className="inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-900 text-red-200">
                            Fatal Crash
                          </span>
                        ) : (
                          <span className="inline-flex items-center px-3 py-1 rounded-full text-sm bg-orange-900 text-orange-200">
                            Non-Fatal Exception
                          </span>
                        )}
                        {selectedCrash.resolved && (
                          <span className="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-900 text-green-200">
                            Resolved
                          </span>
                        )}
                      </div>
                    </div>
                    <button
                      onClick={() => setSelectedCrash(null)}
                      className="text-gray-400 hover:text-white"
                    >
                      âœ•
                    </button>
                  </div>

                  <div className="p-6 space-y-6">
                    {/* Exception Info */}
                    <div className="space-y-4">
                      <div>
                        <p className="text-sm text-gray-400 mb-1">Exception Type</p>
                        <p className="text-white font-mono">{selectedCrash.exceptionType}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-400 mb-1">Exception Message</p>
                        <p className="text-white">{selectedCrash.exceptionMessage}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-400 mb-1">Context</p>
                        <p className="text-white">{selectedCrash.context}</p>
                      </div>
                      {selectedCrash.cause && (
                        <div>
                          <p className="text-sm text-gray-400 mb-1">Caused By</p>
                          <p className="text-white font-mono">{selectedCrash.cause.type}: {selectedCrash.cause.message}</p>
                        </div>
                      )}
                    </div>

                    {/* Device Info */}
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <p className="text-sm text-gray-400 mb-1">Device</p>
                        <p className="text-white">{selectedCrash.deviceManufacturer} {selectedCrash.deviceModel}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-400 mb-1">Android Version</p>
                        <p className="text-white">{selectedCrash.androidVersion} (SDK {selectedCrash.androidSdkInt})</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-400 mb-1">App Version</p>
                        <p className="text-white">{selectedCrash.appVersion} ({selectedCrash.appVersionCode})</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-400 mb-1">Build Type</p>
                        <p className="text-white">{selectedCrash.buildType}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-400 mb-1">Timestamp</p>
                        <p className="text-white">{selectedCrash.timestampFormatted}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-400 mb-1">User ID</p>
                        <p className="text-white font-mono">{selectedCrash.userId || 'Anonymous'}</p>
                      </div>
                    </div>

                    {/* Stack Trace */}
                    <div>
                      <p className="text-sm text-gray-400 mb-2">Stack Trace</p>
                      <pre className="bg-gray-900 text-gray-300 p-4 rounded-lg text-xs overflow-x-auto">
                        {selectedCrash.stackTrace}
                      </pre>
                    </div>

                    {/* Resolution Info */}
                    {selectedCrash.resolved && (
                      <div className="bg-green-900 bg-opacity-20 border border-green-700 rounded-lg p-4">
                        <p className="text-sm text-green-200 mb-2">Resolved by {selectedCrash.resolvedBy}</p>
                        <p className="text-sm text-green-300">
                          {new Date(selectedCrash.resolvedAt!).toLocaleString()}
                        </p>
                        {selectedCrash.notes && (
                          <p className="text-sm text-green-200 mt-2">Notes: {selectedCrash.notes}</p>
                        )}
                      </div>
                    )}

                    {/* Actions */}
                    <div className="flex gap-3">
                      {!selectedCrash.resolved && (
                        <button
                          onClick={() => {
                            const notes = prompt('Enter resolution notes (optional):')
                            handleResolveCrash(selectedCrash, notes || undefined)
                          }}
                          className="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2"
                        >
                          <Shield className="w-4 h-4" />
                          Mark as Resolved
                        </button>
                      )}
                      <button
                        onClick={() => handleDeleteCrash(selectedCrash)}
                        className="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2"
                      >
                        <Trash2 className="w-4 h-4" />
                        Delete Crash
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* ========== MONITORING TAB ========== */}
        {activeTab === 'monitoring' && (() => {
          const stats = costMonitor.getDetailedStats()
          const cStats = cacheManager.getStats()

          return (
            <div className="space-y-6">
              {/* Header */}
              <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6">
                <h3 className="text-xl font-bold mb-1">ðŸ“Š Performance & Cost Monitoring</h3>
                <p className="text-blue-100">Real-time tracking of API usage, bandwidth, cache effectiveness, and cost estimates</p>
              </div>

              {/* Session Info */}
              <div className="bg-gray-800 rounded-xl p-6">
                <h4 className="text-lg font-semibold mb-4">Session Information</h4>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-400">Session Start</p>
                    <p className="text-lg font-medium">{new Date(stats.session.startTime).toLocaleString()}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-400">Duration</p>
                    <p className="text-lg font-medium">{stats.session.duration} minutes</p>
                  </div>
                </div>
              </div>

              {/* Cost Summary Cards */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                  <p className="text-sm opacity-90">Database Reads</p>
                  <p className="text-3xl font-bold mt-2">${stats.costs.costBreakdown.databaseReads.toFixed(3)}</p>
                  <p className="text-xs opacity-75 mt-1">{stats.costs.estimatedReads.toLocaleString()} reads</p>
                </div>
                <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                  <p className="text-sm opacity-90">Bandwidth</p>
                  <p className="text-3xl font-bold mt-2">${stats.costs.costBreakdown.bandwidth.toFixed(3)}</p>
                  <p className="text-xs opacity-75 mt-1">{stats.costs.bandwidthMB.toFixed(2)} MB</p>
                </div>
                <div className="bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl p-6 text-white">
                  <p className="text-sm opacity-90">Cloud Functions</p>
                  <p className="text-3xl font-bold mt-2">${stats.costs.costBreakdown.cloudFunctions.toFixed(3)}</p>
                  <p className="text-xs opacity-75 mt-1">{stats.apiCalls.total} calls</p>
                </div>
                <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white">
                  <p className="text-sm opacity-90">Total Cost</p>
                  <p className="text-3xl font-bold mt-2">${stats.costs.costBreakdown.total.toFixed(3)}</p>
                  <p className="text-xs opacity-75 mt-1">Session estimate</p>
                </div>
              </div>

              {/* Cache Effectiveness */}
              <div className="bg-gray-800 rounded-xl p-6">
                <h4 className="text-lg font-semibold mb-4">Cache Effectiveness</h4>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                  <div>
                    <p className="text-sm text-gray-400">Hit Rate</p>
                    <p className="text-3xl font-bold text-green-400">{stats.cache.hitRate.toFixed(1)}%</p>
                    <div className="mt-2 bg-gray-700 rounded-full h-2">
                      <div className="bg-green-500 h-2 rounded-full transition-all" style={{ width: `${stats.cache.hitRate}%` }} />
                    </div>
                  </div>
                  <div>
                    <p className="text-sm text-gray-400">Cache Hits</p>
                    <p className="text-2xl font-bold">{stats.cache.hits}</p>
                    <p className="text-xs text-gray-500 mt-1">Instant responses</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-400">Cache Misses</p>
                    <p className="text-2xl font-bold">{stats.cache.misses}</p>
                    <p className="text-xs text-gray-500 mt-1">API calls made</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-400">Cache Size</p>
                    <p className="text-2xl font-bold">{cStats.size} / {cStats.maxSize}</p>
                    <p className="text-xs text-gray-500 mt-1">Entries stored</p>
                  </div>
                </div>
              </div>

              {/* Performance Metrics */}
              <div className="bg-gray-800 rounded-xl p-6">
                <h4 className="text-lg font-semibold mb-4">Performance Metrics</h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="text-center p-4 bg-gray-700 rounded-lg">
                    <p className="text-sm text-gray-400">Average</p>
                    <p className="text-2xl font-bold">{stats.performance.avgResponseTime}ms</p>
                  </div>
                  <div className="text-center p-4 bg-gray-700 rounded-lg">
                    <p className="text-sm text-gray-400">P95</p>
                    <p className="text-2xl font-bold">{stats.performance.p95ResponseTime}ms</p>
                  </div>
                  <div className="text-center p-4 bg-gray-700 rounded-lg">
                    <p className="text-sm text-gray-400">Min</p>
                    <p className="text-2xl font-bold text-green-400">{stats.performance.minResponseTime}ms</p>
                  </div>
                  <div className="text-center p-4 bg-gray-700 rounded-lg">
                    <p className="text-sm text-gray-400">Max</p>
                    <p className="text-2xl font-bold text-red-400">{stats.performance.maxResponseTime}ms</p>
                  </div>
                </div>
              </div>

              {/* API Calls by Endpoint */}
              <div className="bg-gray-800 rounded-xl p-6">
                <h4 className="text-lg font-semibold mb-4">API Calls by Endpoint</h4>
                <div className="space-y-3">
                  {Object.keys(stats.apiCalls.byEndpoint).length === 0 ? (
                    <div className="text-center py-8 text-gray-400">
                      <Activity className="w-12 h-12 mx-auto mb-3 opacity-50" />
                      <p>No API calls recorded yet.</p>
                      <p className="text-sm mt-1">Navigate between tabs to generate data.</p>
                    </div>
                  ) : (
                    Object.entries(stats.apiCalls.byEndpoint)
                      .sort(([, a], [, b]) => (b as number) - (a as number))
                      .map(([endpoint, count]) => (
                        <div key={endpoint} className="flex items-center justify-between">
                          <div className="flex-1">
                            <p className="font-medium">{endpoint}</p>
                            <div className="mt-1 bg-gray-700 rounded-full h-2">
                              <div
                                className="bg-blue-500 h-2 rounded-full transition-all"
                                style={{ width: `${((count as number) / stats.apiCalls.total) * 100}%` }}
                              />
                            </div>
                          </div>
                          <div className="ml-4 text-right">
                            <p className="text-lg font-bold">{count as number}</p>
                            <p className="text-xs text-gray-400">
                              {(((count as number) / stats.apiCalls.total) * 100).toFixed(1)}%
                            </p>
                          </div>
                        </div>
                      ))
                  )}
                </div>
              </div>

              {/* Bandwidth by Endpoint */}
              <div className="bg-gray-800 rounded-xl p-6">
                <h4 className="text-lg font-semibold mb-4">Bandwidth by Endpoint</h4>
                <div className="space-y-3">
                  {Object.keys(stats.bandwidth.byEndpoint).length === 0 ? (
                    <p className="text-gray-400 text-center py-8">No bandwidth data recorded yet.</p>
                  ) : (
                    Object.entries(stats.bandwidth.byEndpoint)
                      .sort(([, a], [, b]) => (b as number) - (a as number))
                      .map(([endpoint, mb]) => (
                        <div key={endpoint} className="flex items-center justify-between">
                          <div className="flex-1">
                            <p className="font-medium">{endpoint}</p>
                            <div className="mt-1 bg-gray-700 rounded-full h-2">
                              <div
                                className="bg-purple-500 h-2 rounded-full transition-all"
                                style={{ width: `${((mb as number) / stats.costs.bandwidthMB) * 100}%` }}
                              />
                            </div>
                          </div>
                          <div className="ml-4 text-right">
                            <p className="text-lg font-bold">{(mb as number).toFixed(2)} MB</p>
                            <p className="text-xs text-gray-400">
                              {(((mb as number) / stats.costs.bandwidthMB) * 100).toFixed(1)}%
                            </p>
                          </div>
                        </div>
                      ))
                  )}
                </div>
              </div>

              {/* Optimization Impact */}
              <div className="bg-gradient-to-r from-green-900/30 to-blue-900/30 border-2 border-green-500/30 rounded-xl p-6">
                <h4 className="text-lg font-semibold mb-4">ðŸ’¡ Optimization Impact</h4>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="bg-gray-800 rounded-lg p-4">
                    <p className="text-sm text-gray-400 mb-2">Cache Savings</p>
                    <p className="text-2xl font-bold text-green-400">{stats.cache.hits} calls</p>
                    <p className="text-xs text-gray-500 mt-1">
                      Avoided by caching ({stats.cache.hitRate.toFixed(0)}% hit rate)
                    </p>
                  </div>
                  <div className="bg-gray-800 rounded-lg p-4">
                    <p className="text-sm text-gray-400 mb-2">Estimated Savings</p>
                    <p className="text-2xl font-bold text-green-400">
                      ${((stats.cache.hits / (stats.cache.hits + stats.cache.misses)) * stats.costs.costBreakdown.total).toFixed(3)}
                    </p>
                    <p className="text-xs text-gray-500 mt-1">Saved by caching (session)</p>
                  </div>
                  <div className="bg-gray-800 rounded-lg p-4">
                    <p className="text-sm text-gray-400 mb-2">Cache Efficiency</p>
                    <p className="text-2xl font-bold text-blue-400">
                      {stats.cache.hitRate > 70 ? 'Excellent' : stats.cache.hitRate > 50 ? 'Good' : 'Fair'}
                    </p>
                    <p className="text-xs text-gray-500 mt-1">Target: &gt;70% hit rate</p>
                  </div>
                </div>
              </div>

              {/* Actions */}
              <div className="flex gap-3">
                <button
                  onClick={() => window.location.reload()}
                  className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors"
                >
                  <RefreshCw className="w-4 h-4" />
                  Refresh Data
                </button>
                <button
                  onClick={() => {
                    const data = costMonitor.exportData()
                    const blob = new Blob([data], { type: 'application/json' })
                    const url = URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.href = url
                    a.download = `syncflow-monitoring-${Date.now()}.json`
                    a.click()
                    URL.revokeObjectURL(url)
                  }}
                  className="flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors"
                >
                  <Database className="w-4 h-4" />
                  Export Data
                </button>
                <button
                  onClick={() => {
                    if (confirm('Reset all monitoring data? This cannot be undone.')) {
                      costMonitor.reset()
                      cacheManager.clear()
                      window.location.reload()
                    }
                  }}
                  className="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors"
                >
                  <Trash2 className="w-4 h-4" />
                  Reset Data
                </button>
              </div>

              {/* Info Footer */}
              <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                <p className="text-sm text-blue-200">
                  <strong>ðŸ“Š Note:</strong> Cost estimates are based on Firebase pricing (Feb 2026) and average usage patterns.
                  Data is stored locally and persists between sessions. Monitoring tracks API calls automatically once integrated
                  into firebase.ts (see <code className="bg-gray-800 px-2 py-1 rounded">MONITORING_INTEGRATION_GUIDE.md</code>).
                </p>
              </div>
            </div>
          )
        })()}

        {/* ========== DATABASE BROWSER TAB ========== */}
        {activeTab === 'database' && (
          <div className="space-y-6">
            {dbError && (
              <div className="p-4 bg-red-900/30 border border-red-700 rounded-lg text-red-300 flex items-center justify-between">
                <span>{dbError}</span>
                <button onClick={() => setDbError('')} className="text-red-400 hover:text-red-300 ml-2">âœ•</button>
              </div>
            )}

            {/* Sub-tabs: Browse / SQL Query */}
            <div className="flex gap-2 border-b border-gray-700 pb-2">
              <button onClick={() => setDbActiveSubTab('browse')} className={`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors ${dbActiveSubTab === 'browse' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:text-gray-200'}`}>Browse Tables</button>
              <button onClick={() => setDbActiveSubTab('query')} className={`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors ${dbActiveSubTab === 'query' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:text-gray-200'}`}>SQL Query</button>
            </div>

            {/* SQL Query Tab */}
            {dbActiveSubTab === 'query' && (
              <div className="space-y-4">
                <div className="bg-gray-800 rounded-lg p-4">
                  <label className="block text-sm font-medium text-gray-300 mb-2">SQL Query</label>
                  <textarea
                    value={dbSqlQuery}
                    onChange={(e) => setDbSqlQuery(e.target.value)}
                    onKeyDown={(e) => { if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) runDbQuery() }}
                    placeholder="SELECT * FROM user_messages LIMIT 10;"
                    rows={5}
                    className="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white font-mono text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                  <div className="flex items-center gap-3 mt-3">
                    <button onClick={runDbQuery} disabled={dbQueryLoading || !dbSqlQuery.trim()} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg text-white text-sm">
                      {dbQueryLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Zap className="w-4 h-4" />}
                      Run Query
                    </button>
                    <span className="text-xs text-gray-500">Cmd+Enter to run</span>
                  </div>
                </div>

                {dbQueryError && (
                  <div className="p-4 bg-red-900/30 border border-red-700 rounded-lg text-red-300 font-mono text-sm">{dbQueryError}</div>
                )}

                {dbQueryResult && (
                  <div className="space-y-2">
                    <div className="text-sm text-gray-400">
                      {dbQueryResult.rows ? `${dbQueryResult.rows.length} rows returned` : `${dbQueryResult.rowCount ?? 0} rows affected`}
                      {dbQueryResult.duration && ` in ${dbQueryResult.duration}ms`}
                    </div>
                    {dbQueryResult.rows && dbQueryResult.rows.length > 0 && (
                      <div className="bg-gray-800 rounded-lg overflow-x-auto max-h-96 overflow-y-auto">
                        <table className="w-full">
                          <thead className="bg-gray-900 border-b border-gray-700 sticky top-0">
                            <tr>
                              {Object.keys(dbQueryResult.rows[0]).map((col) => (
                                <th key={col} className="px-3 py-2 text-left text-xs font-semibold text-gray-300 whitespace-nowrap">{col}</th>
                              ))}
                            </tr>
                          </thead>
                          <tbody>
                            {dbQueryResult.rows.map((row: any, i: number) => (
                              <tr key={i} className="border-b border-gray-700">
                                {Object.values(row).map((val: any, j: number) => (
                                  <td key={j} className="px-3 py-2 text-xs text-gray-300 max-w-xs truncate">
                                    {val === null ? <span className="text-gray-600 italic">null</span> : typeof val === 'object' ? <span className="font-mono text-gray-400">{JSON.stringify(val).substring(0, 100)}</span> : String(val)}
                                  </td>
                                ))}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {/* Browse Tab */}
            {dbActiveSubTab === 'browse' && (
              <>
                {/* Table List View */}
                {!dbSelectedTable && (
                  <>
                    {dbHealth && (
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-gray-800 rounded-lg p-4">
                          <div className="text-sm text-gray-400">Database Size</div>
                          <div className="text-xl font-bold text-white">{dbHealth.dbSize}</div>
                        </div>
                        <div className="bg-gray-800 rounded-lg p-4">
                          <div className="text-sm text-gray-400">Active Connections</div>
                          <div className="text-xl font-bold text-white">{dbHealth.activeConnections} / {dbHealth.maxConnections}</div>
                        </div>
                        <div className="bg-gray-800 rounded-lg p-4">
                          <div className="text-sm text-gray-400">Uptime</div>
                          <div className="text-xl font-bold text-white">{typeof dbHealth.uptime === 'object' ? `${(dbHealth.uptime as any).days || 0}d ${(dbHealth.uptime as any).hours || 0}h ${(dbHealth.uptime as any).minutes || 0}m` : String(dbHealth.uptime)}</div>
                        </div>
                        <div className="bg-gray-800 rounded-lg p-4">
                          <div className="text-sm text-gray-400">Total Tables</div>
                          <div className="text-xl font-bold text-white">{dbTables.length}</div>
                        </div>
                      </div>
                    )}

                    <div className="flex items-center gap-4">
                      <input type="text" value={dbTableFilter} onChange={(e) => setDbTableFilter(e.target.value)} placeholder="Filter tables..." className="w-80 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500" />
                      <button onClick={() => { loadDbTables(); loadDbHealth() }} disabled={isLoadingDb} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg text-white transition-colors">
                        {isLoadingDb ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />}
                        Refresh
                      </button>
                    </div>

                    {isLoadingDb ? (
                      <div className="flex items-center justify-center py-16"><Loader2 className="w-10 h-10 animate-spin text-blue-400" /></div>
                    ) : (
                      <div className="bg-gray-800 rounded-lg overflow-hidden">
                        <table className="w-full">
                          <thead className="bg-gray-900 border-b border-gray-700">
                            <tr>
                              <th className="px-4 py-3 text-left text-sm font-semibold text-gray-300 cursor-pointer hover:text-white" onClick={() => handleDbTableSort('name')}>Table Name{dbTableSortField === 'name' ? (dbTableSortOrder === 'asc' ? ' â†‘' : ' â†“') : ''}</th>
                              <th className="px-4 py-3 text-right text-sm font-semibold text-gray-300 cursor-pointer hover:text-white" onClick={() => handleDbTableSort('estimatedRows')}>Est. Rows{dbTableSortField === 'estimatedRows' ? (dbTableSortOrder === 'asc' ? ' â†‘' : ' â†“') : ''}</th>
                              <th className="px-4 py-3 text-right text-sm font-semibold text-gray-300 cursor-pointer hover:text-white" onClick={() => handleDbTableSort('totalSizeBytes')}>Size{dbTableSortField === 'totalSizeBytes' ? (dbTableSortOrder === 'asc' ? ' â†‘' : ' â†“') : ''}</th>
                            </tr>
                          </thead>
                          <tbody>
                            {sortedDbTables.map((table) => (
                              <tr key={table.name} className="border-b border-gray-700 hover:bg-blue-900/20 cursor-pointer" onClick={() => openDbTable(table.name)}>
                                <td className="px-4 py-3 text-sm font-mono text-blue-400">{table.name}</td>
                                <td className="px-4 py-3 text-sm text-right text-gray-300">{table.estimatedRows.toLocaleString()}</td>
                                <td className="px-4 py-3 text-sm text-right text-gray-300">{table.totalSize}</td>
                              </tr>
                            ))}
                            {sortedDbTables.length === 0 && (
                              <tr><td colSpan={3} className="px-4 py-8 text-center text-gray-500">{dbTableFilter ? 'No tables match filter' : 'No tables found'}</td></tr>
                            )}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </>
                )}

                {/* Table Data View */}
                {dbSelectedTable && (
                  <>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <button onClick={closeDbTable} className="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-gray-300 text-sm">â† Back</button>
                        <h2 className="text-xl font-bold text-white font-mono">{dbSelectedTable}</h2>
                        <span className="text-sm text-gray-400">{dbTotal.toLocaleString()} rows</span>
                      </div>
                    </div>

                    {dbSchema.length > 0 && (
                      <details className="bg-gray-800 rounded-lg p-4">
                        <summary className="text-sm font-semibold text-gray-300 cursor-pointer">Schema ({dbSchema.length} columns)</summary>
                        <div className="mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                          {dbSchema.map((col) => (
                            <div key={col.name} className="text-xs font-mono p-2 bg-gray-900 rounded">
                              <span className={col.isPrimaryKey ? 'text-yellow-400 font-bold' : 'text-gray-100'}>{col.name}</span>
                              <span className="text-gray-500 ml-2">{col.type}</span>
                              {col.isPrimaryKey && <span className="text-yellow-400 ml-1">PK</span>}
                              {!col.nullable && <span className="text-red-400 ml-1">NOT NULL</span>}
                            </div>
                          ))}
                        </div>
                      </details>
                    )}

                    <div className="flex gap-2 items-center">
                      <input type="text" value={dbSearch} onChange={(e) => setDbSearch(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleDbSearch()} placeholder="Search text columns..." className="w-64 px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm placeholder-gray-500" />
                      <button onClick={handleDbSearch} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white text-sm">Search</button>
                      {dbSearch && <button onClick={() => { setDbSearch(''); if (dbSelectedTable) loadDbTableData(dbSelectedTable, 0, dbSort, dbSortDir, '') }} className="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-gray-300 text-sm">Clear</button>}
                    </div>

                    {isLoadingDbData ? (
                      <div className="flex items-center justify-center py-16"><Loader2 className="w-10 h-10 animate-spin text-blue-400" /></div>
                    ) : (
                      <div className="bg-gray-800 rounded-lg overflow-x-auto">
                        <table className="w-full">
                          <thead className="bg-gray-900 border-b border-gray-700">
                            <tr>
                              <th className="px-2 py-2 text-xs font-semibold text-gray-500 w-20">Actions</th>
                              {dbColumns.map((col) => (
                                <th key={col} className="px-3 py-2 text-left text-xs font-semibold text-gray-300 cursor-pointer hover:text-white whitespace-nowrap" onClick={() => handleDbColumnSort(col)}>
                                  {col}{dbSort === col ? (dbSortDir === 'ASC' ? ' â†‘' : ' â†“') : ''}
                                </th>
                              ))}
                            </tr>
                          </thead>
                          <tbody>
                            {dbRows.map((row, i) => (
                              <tr key={i} className="border-b border-gray-700 hover:bg-gray-900/50">
                                <td className="px-2 py-2 text-xs whitespace-nowrap">
                                  <div className="flex gap-1">
                                    <button onClick={() => dbStartEdit(row)} className="p-1 text-blue-400 hover:text-blue-300" title="Edit"><Pencil className="w-3.5 h-3.5" /></button>
                                    <button onClick={() => setDbDeletingRow(row)} className="p-1 text-red-400 hover:text-red-300" title="Delete"><Trash2 className="w-3.5 h-3.5" /></button>
                                  </div>
                                </td>
                                {dbColumns.map((col) => (
                                  <td key={col} className="px-3 py-2 text-xs text-gray-300 max-w-xs truncate">
                                    {row[col] === null ? <span className="text-gray-600 italic">null</span> : typeof row[col] === 'object' ? <span className="font-mono text-gray-400">{JSON.stringify(row[col]).substring(0, 100)}</span> : String(row[col])}
                                  </td>
                                ))}
                              </tr>
                            ))}
                            {dbRows.length === 0 && (
                              <tr><td colSpan={(dbColumns.length || 1) + 1} className="px-4 py-8 text-center text-gray-500">No data found</td></tr>
                            )}
                          </tbody>
                        </table>
                      </div>
                    )}

                    {dbTotalPages > 1 && (
                      <div className="flex items-center justify-center gap-2">
                        <button onClick={() => loadDbTableData(dbSelectedTable, 0, dbSort, dbSortDir, dbSearch)} disabled={dbPage === 0} className="px-3 py-1.5 text-sm bg-gray-700 hover:bg-gray-600 rounded disabled:opacity-40 text-gray-300">First</button>
                        <button onClick={() => loadDbTableData(dbSelectedTable, dbPage - 1, dbSort, dbSortDir, dbSearch)} disabled={dbPage === 0} className="px-3 py-1.5 text-sm bg-gray-700 hover:bg-gray-600 rounded disabled:opacity-40 text-gray-300">Prev</button>
                        <span className="text-sm text-gray-400 px-3">{dbPage + 1} / {dbTotalPages}</span>
                        <button onClick={() => loadDbTableData(dbSelectedTable, dbPage + 1, dbSort, dbSortDir, dbSearch)} disabled={dbPage >= dbTotalPages - 1} className="px-3 py-1.5 text-sm bg-gray-700 hover:bg-gray-600 rounded disabled:opacity-40 text-gray-300">Next</button>
                        <button onClick={() => loadDbTableData(dbSelectedTable, dbTotalPages - 1, dbSort, dbSortDir, dbSearch)} disabled={dbPage >= dbTotalPages - 1} className="px-3 py-1.5 text-sm bg-gray-700 hover:bg-gray-600 rounded disabled:opacity-40 text-gray-300">Last</button>
                      </div>
                    )}
                  </>
                )}
              </>
            )}

            {/* Edit Row Modal */}
            {dbEditingRow && (
              <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={() => setDbEditingRow(null)}>
                <div className="bg-gray-800 rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-bold text-white">Edit Row</h3>
                    <button onClick={() => setDbEditingRow(null)} className="text-gray-400 hover:text-white"><X className="w-5 h-5" /></button>
                  </div>
                  {dbEditError && <div className="p-3 bg-red-900/30 border border-red-700 rounded-lg text-red-300 text-sm mb-4">{dbEditError}</div>}
                  <div className="space-y-3">
                    {dbColumns.map((col) => {
                      const schema = dbSchema.find(s => s.name === col)
                      const isPk = schema?.isPrimaryKey
                      return (
                        <div key={col}>
                          <label className="block text-xs font-medium text-gray-400 mb-1">
                            {col} <span className="text-gray-600">{schema?.type}{isPk ? ' (PK)' : ''}</span>
                          </label>
                          <input
                            type="text"
                            value={dbEditValues[col] === null ? '' : typeof dbEditValues[col] === 'object' ? JSON.stringify(dbEditValues[col]) : String(dbEditValues[col] ?? '')}
                            onChange={(e) => setDbEditValues(prev => ({ ...prev, [col]: e.target.value || null }))}
                            disabled={isPk}
                            className={`w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white text-sm font-mono ${isPk ? 'opacity-50' : ''}`}
                          />
                        </div>
                      )
                    })}
                  </div>
                  <div className="flex justify-end gap-3 mt-6">
                    <button onClick={() => setDbEditingRow(null)} className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-gray-300 text-sm">Cancel</button>
                    <button onClick={dbSaveEdit} disabled={dbEditLoading} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-lg text-white text-sm">
                      {dbEditLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Check className="w-4 h-4" />}
                      Save Changes
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Delete Confirmation Modal */}
            {dbDeletingRow && (
              <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={() => setDbDeletingRow(null)}>
                <div className="bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4" onClick={(e) => e.stopPropagation()}>
                  <div className="flex items-center gap-3 mb-4">
                    <AlertTriangle className="w-6 h-6 text-red-400" />
                    <h3 className="text-lg font-bold text-white">Delete Row</h3>
                  </div>
                  <p className="text-gray-300 mb-2">Are you sure you want to delete this row from <span className="font-mono text-blue-400">{dbSelectedTable}</span>?</p>
                  <div className="bg-gray-900 rounded-lg p-3 mb-4 max-h-32 overflow-y-auto">
                    {dbGetPrimaryKey() && <p className="text-xs font-mono text-gray-400">{dbGetPrimaryKey()}: <span className="text-white">{dbDeletingRow[dbGetPrimaryKey()!]}</span></p>}
                  </div>
                  <div className="flex justify-end gap-3">
                    <button onClick={() => setDbDeletingRow(null)} className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-gray-300 text-sm">Cancel</button>
                    <button onClick={dbConfirmDelete} disabled={dbDeleteLoading} className="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 disabled:opacity-50 rounded-lg text-white text-sm">
                      {dbDeleteLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Trash2 className="w-4 h-4" />}
                      Delete
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === 'testing' && (
          <div className="space-y-6">
            <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl p-6">
              <h3 className="text-xl font-bold mb-1">ðŸ§ª User Plan Assignment</h3>
              <p className="text-purple-100 mb-6">Assign plans to test free vs. paid functionality</p>

              <div className="bg-gray-800 rounded-lg p-6 space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">User ID</label>
                  <input
                    type="text"
                    value={testUserId}
                    onChange={(e) => setTestUserId(e.target.value)}
                    placeholder="Enter user Firebase ID (e.g., abc123def456)"
                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">Plan</label>
                    <select
                      value={testPlan}
                      onChange={(e) => setTestPlan(e.target.value as any)}
                      className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                    >
                      <option value="free">Free (7-day trial)</option>
                      <option value="monthly">Monthly Paid</option>
                      <option value="yearly">Yearly Paid</option>
                      <option value="lifetime">Lifetime</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">Days Valid</label>
                    <input
                      type="number"
                      value={testDaysValid}
                      onChange={(e) => setTestDaysValid(e.target.value)}
                      placeholder="7"
                      min="1"
                      max="365"
                      className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                    />
                  </div>
                </div>

                <button
                  onClick={handleSetUserPlan}
                  disabled={isSettingPlan || !testUserId.trim()}
                  className="w-full flex items-center justify-center gap-2 px-6 py-3 bg-white text-purple-600 font-semibold rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:bg-gray-400 transition-colors"
                >
                  {isSettingPlan ? <Loader2 className="w-5 h-5 animate-spin" /> : <Zap className="w-5 h-5" />}
                  {isSettingPlan ? 'Assigning Plan...' : 'Assign Plan'}
                </button>

                <div className="bg-gray-700 rounded-lg p-4 mt-6">
                  <p className="text-sm text-gray-300 mb-2">
                    <strong>Quick Test Cases:</strong>
                  </p>
                  <ul className="text-sm text-gray-400 space-y-1 ml-4">
                    <li>âœ… Expired Free User: Plan = "free", Days = 1</li>
                    <li>âœ… Active Trial User: Plan = "free", Days = 7</li>
                    <li>âœ… Monthly Subscriber: Plan = "monthly", Days = 30</li>
                    <li>âœ… Lifetime User: Plan = "lifetime", Days = 365</li>
                  </ul>
                </div>
              </div>
            </div>

            <div className="bg-gray-800 rounded-xl p-6 flex-1 flex flex-col">
              <h3 className="text-lg font-semibold mb-4">Assignment Log</h3>
              <div className="flex-1 overflow-y-auto bg-gray-900 rounded-lg p-4 font-mono text-sm space-y-1">
                {cleanupLog.length === 0 ? (
                  <p className="text-gray-500">No plan assignments yet. Assign a plan above to see logs.</p>
                ) : (
                  cleanupLog.map((log: string, index: number) => (
                    <div key={index} className="text-gray-300">{log}</div>
                  ))
                )}
              </div>
            </div>
          </div>
        )}
      </div>

      {/* ==================== CONFIRM DIALOG ==================== */}
      {confirmDialog && (
        <ConfirmDialog
          open={confirmDialog.open}
          title={confirmDialog.title}
          message={confirmDialog.message}
          confirmText={confirmDialog.confirmText}
          confirmButtonText={confirmDialog.confirmButtonText}
          requireTyping={confirmDialog.requireTyping}
          onConfirm={confirmDialog.onConfirm}
          onCancel={() => setConfirmDialog(null)}
        />
      )}
    </div>
  )
}
